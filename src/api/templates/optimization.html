{% extends "base.html" %}

{% block title %}Optimizer - BrandCompass.ai{% endblock %}

{% block content %}
<div class="container fade-in">
    <div class="hero">
        <h1 class="hero-title">Optimizer</h1>
        <p class="hero-subtitle">Optimize media spend allocation to maximize brand power</p>
    </div>

    <!-- Upload Status Alert -->
    <div id="uploadStatusAlert" class="alert alert-info mb-4" style="display:none;">
        <strong>✓ Data uploaded:</strong> <span id="uploadedFileName"></span>
        <br>
        <small>Rows: <span id="uploadedRows">0</span> | Columns: <span id="uploadedCols">0</span></small>
    </div>

    <div id="noDataAlert" class="alert alert-warning mb-4">
        <strong>⚠ No data uploaded</strong>
        <p class="mt-2 mb-0">Please <a href="/" class="alert-link">go back to home</a> and upload your data first.</p>
    </div>

    <!-- Data Viewer Section -->
    <div class="card" id="dataViewerCard" style="display:none;">
        <div class="card-header">
            <span>Data Viewer</span>
        </div>
        <div class="card-body">
            <div class="row" style="display:flex; gap:1rem; align-items: flex-end; flex-wrap:wrap;">
                <div class="form-group" style="min-width:220px;">
                    <label class="form-label">Total Budget ($)</label>
                    <input type="number" id="budgetAmount" class="form-control" placeholder="Enter total budget" value="1000000000">
                </div>
                <div style="flex:1 1 auto; text-align:right;">
                    <button id="optimizeBtn" class="btn btn-primary" onclick="runOptimization()">
                        <svg width="16" height="16" fill="currentColor" style="margin-right: 0.5rem; vertical-align: middle;">
                            <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.5 7.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5z"/>
                        </svg>
                        Optimize Marketing Spend
                    </button>
                </div>
            </div>

            <!-- Filter Controls -->
            <div id="filtersRow" class="row" style="display:none; gap:1rem; align-items:flex-end; flex-wrap:wrap; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                <div class="form-group" style="min-width:200px;">
                    <label class="form-label">Filter by Brand</label>
                    <select id="filterBrand" class="form-control">
                        <option value="All">All Brands</option>
                    </select>
                </div>
                <div class="form-group" style="min-width:140px;">
                    <label class="form-label">Quarter</label>
                    <select id="filterQuarter" class="form-control">
                        <option value="All">All Quarters</option>
                        <option value="2024 Q3">2024 Q3</option>
                        <option value="2024 Q4">2024 Q4</option>
                        <option value="2025 Q1">2025 Q1</option>
                        <option value="2025 Q2">2025 Q2</option>
                    </select>
                </div>
                <div style="flex:1 1 auto; text-align:right;">
                    <button id="resetFiltersBtn" class="btn btn-secondary btn-slim" onclick="resetFilters()">Reset Filters</button>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div class="mt-4" id="loadingIndicator" style="display:none;">
                <div class="spinner"></div>
                <p class="text-center mt-3">Optimizing marketing spend allocation...</p>
            </div>
        </div>
    </div>

    <!-- Optimization Results Section -->
    <section id="resultsSection" class="mb-5" style="display: none;">
        <!-- Summary Cards -->
        <div id="summaryCards" class="row mb-4" style="display:none; gap: 1rem;">
            <!-- Cards will be injected here -->
        </div>

        <!-- Results Table -->
        <div class="card">
            <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
                <span id="resultsTitle">Optimization Results</span>
                <div>
                    <button class="btn btn-secondary btn-slim" onclick="downloadOptimizedCSV()" style="margin-right: 0.5rem;">
                        <svg width="14" height="14" fill="currentColor" style="margin-right: 0.25rem; vertical-align: middle;">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        Download CSV
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="resultsTable"></div>
            </div>
        </div>

        <!-- Power Comparison Chart -->
        <div class="card mt-4" id="chartCard" style="display:none;">
            <div class="card-header">
                <span>Brand Power Comparison</span>
            </div>
            <div class="card-body">
                <div id="powerChart"></div>
            </div>
        </div>
    </section>

    <div class="text-center mt-4">
        <a href="/" class="btn btn-secondary">Back to Home</a>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    // Set selected country in body dataset for chat widget
    {% if selected_country %}
    document.body.dataset.selectedCountry = "{{ selected_country }}";
    {% endif %}

    console.log('=== OPTIMIZER SCRIPT LOADING ===');

    let optimizedData = null;
    let optimizationResult = null;
    let allResultsData = [];

    // Check for uploaded data on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkUploadedData();
    });

    async function checkUploadedData() {
        try {
            // Load UI state from server
            const response = await fetch('/api/v1/ui-state');
            if (response.ok) {
                const state = await response.json();
                const uploadedFile = state.last_uploaded_file;
                const uploadMeta = state.last_uploaded_meta;

                if (uploadedFile && uploadMeta) {
                    // Show upload status
                    document.getElementById('uploadedFileName').textContent = uploadMeta.filename || 'Data file';
                    document.getElementById('uploadedRows').textContent = uploadMeta.rows || 0;
                    document.getElementById('uploadedCols').textContent = uploadMeta.cols || 0;
                    document.getElementById('uploadStatusAlert').style.display = 'block';
                    document.getElementById('noDataAlert').style.display = 'none';
                    document.getElementById('dataViewerCard').style.display = 'block';
                } else {
                    showNoDataState();
                }
            } else {
                showNoDataState();
            }
        } catch (error) {
            console.error('Error checking uploaded data:', error);
            showNoDataState();
        }
    }

    function showNoDataState() {
        document.getElementById('uploadStatusAlert').style.display = 'none';
        document.getElementById('noDataAlert').style.display = 'block';
        document.getElementById('dataViewerCard').style.display = 'none';
    }

    function runOptimization() {
        console.log('=== OPTIMIZER: Optimize Clicked ===');

        const optimizeBtn = document.getElementById('optimizeBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const budgetEl = document.getElementById('budgetAmount');
        const budgetRaw = budgetEl && budgetEl.value ? budgetEl.value.trim() : '';
        console.log('Budget input:', budgetRaw);

        if (!budgetRaw || parseFloat(budgetRaw) <= 0) {
            alert('Please enter a valid budget amount');
            return;
        }

        // Show loading state
        optimizeBtn.disabled = true;
        const originalBtnText = optimizeBtn.innerHTML;
        optimizeBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; margin-right: 0.5rem; display: inline-block;"></div> Optimizing...';
        loadingIndicator.style.display = 'block';
        document.getElementById('resultsSection').style.display = 'none';

        const endpoint = '/api/v1/optimize/brand-power';
        console.log('Sending POST request to', endpoint);
        const startTime = Date.now();

        const requestBody = { 
            total_budget: parseFloat(budgetRaw),
            brands: ['AGUILA', 'FAMILIA POKER', 'FAMILIA CORONA', 'FAMILIA CLUB COLOMBIA'],
            quarters: ['2024 Q3', '2024 Q4', '2025 Q1', '2025 Q2'],
            mode: 'all_brands',
            method: 'gradient',
            constraints: { paytv_max_pct: 0.5 }
        };

        fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        })
            .then(async (response) => {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`Response received after ${elapsed}s`);

                if (!response.ok) {
                    let msg = 'Server error';
                    try {
                        const e = await response.json();
                        if (e && e.detail) msg = e.detail;
                        console.error('Server error:', e);
                    } catch (err) {
                        console.error('Failed to parse error response:', err);
                    }
                    throw new Error(msg);
                }
                return response.json();
            })
            .then(data => {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`Optimization completed in ${elapsed}s`);
                console.log('Data received:', data);

                // Save result
                optimizationResult = data;

                // Display results
                displayBrandPowerResults(data, budgetRaw);

                optimizeBtn.disabled = false;
                optimizeBtn.innerHTML = originalBtnText;
                loadingIndicator.style.display = 'none';
            })
            .catch(error => {
                console.error('Optimization error:', error);
                alert(`Optimization failed: ${error.message}`);
                optimizeBtn.disabled = false;
                optimizeBtn.innerHTML = originalBtnText;
                loadingIndicator.style.display = 'none';
            });
    }

    function displayDataTable(data, budgetRaw) {
        const brandSel = document.getElementById('filterBrand');
        const yearSel = document.getElementById('filterYear');
        const monthSel = document.getElementById('filterMonth');

        let filtered = (data && data.data) ? data.data : [];
        if (brandSel && brandSel.value && brandSel.value !== 'All') {
            filtered = filtered.filter(r => String(r.brand) === brandSel.value);
        }
        if (yearSel && yearSel.value && yearSel.value !== 'All') {
            filtered = filtered.filter(r => String(r.week) && Math.floor((parseInt(r.week) - 1) / 13) + 1 === parseInt(yearSel.value));
        }

        optimizedData = filtered;

        const displayData = filtered.slice(0, 100);
        let tableHTML = `
            <div class="table-container">
                <table class="table table-striped">
                    <thead>
                        <tr>
        `;

        // Add column headers
        data.columns.forEach(col => {
            tableHTML += `<th>${col}</th>`;
        });

        tableHTML += `
                        </tr>
                    </thead>
                    <tbody>
        `;

        // Add data rows
        displayData.forEach(row => {
            tableHTML += '<tr>';
            data.columns.forEach(col => {
                const value = row[col];
                const displayValue = typeof value === 'number' ?
                    value.toLocaleString(undefined, { maximumFractionDigits: 2 }) :
                    String(value || '');
                tableHTML += `<td>${displayValue}</td>`;
            });
            tableHTML += '</tr>';
        });

        if (filtered.length > 100) {
            tableHTML += `
                <tr>
                    <td colspan="${data.columns.length}" class="text-center text-muted" style="padding: 1rem;">
                        <em>Showing first 100 of ${filtered.length} rows. Download CSV to see all data.</em>
                    </td>
                </tr>
            `;
        }

        tableHTML += '</tbody></table></div>';

        document.getElementById('resultsTable').innerHTML = tableHTML;
        document.getElementById('resultsSection').style.display = 'block';

        console.log('=== Data table displayed successfully ===');
    }

    function displayBrandPowerResults(data, budgetRaw) {
        console.log('Displaying Brand Power Optimizer results:', data);
        
        const resultsSection = document.getElementById('resultsSection');
        const resultsTable = document.getElementById('resultsTable');
        const summaryCards = document.getElementById('summaryCards');
        const chartCard = document.getElementById('chartCard');
        
        // Check if fallback was used
        const usedFallback = data.fallback_used || data.optimizer_used === 'ga_fallback';
        const optimizerName = usedFallback ? 'GA Optimizer (Fallback)' : 'Brand Power Optimizer';
        
        // Show warning if fallback was used
        if (usedFallback) {
            const warningHtml = `
                <div class="alert alert-warning mb-4">
                    <strong>⚠️ Note:</strong> Primary optimizer encountered an issue. Automatically switched to GA Optimizer.
                    ${data.fallback_reason ? `<br><small>Reason: ${data.fallback_reason}</small>` : ''}
                </div>
            `;
            summaryCards.insertAdjacentHTML('beforebegin', warningHtml);
        }
        
        // Build summary cards
        const cardsHtml = `
            <div class="col" style="flex: 1; min-width: 200px;">
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                    <div class="card-body" style="padding: 1.5rem;">
                        <h6 style="opacity: 0.9; margin-bottom: 0.5rem; font-size: 0.875rem;">Total Budget</h6>
                        <h3 style="margin: 0; font-weight: 700;">$${parseFloat(budgetRaw).toLocaleString(undefined, {maximumFractionDigits: 0})}</h3>
                    </div>
                </div>
            </div>
            <div class="col" style="flex: 1; min-width: 200px;">
                <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none;">
                    <div class="card-body" style="padding: 1.5rem;">
                        <h6 style="opacity: 0.9; margin-bottom: 0.5rem; font-size: 0.875rem;">Power Uplift</h6>
                        <h3 style="margin: 0; font-weight: 700;">+${data.total_uplift_pct.toFixed(2)}%</h3>
                    </div>
                </div>
            </div>
            <div class="col" style="flex: 1; min-width: 200px;">
                <div class="card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none;">
                    <div class="card-body" style="padding: 1.5rem;">
                        <h6 style="opacity: 0.9; margin-bottom: 0.5rem; font-size: 0.875rem;">Baseline Power</h6>
                        <h3 style="margin: 0; font-weight: 700;">${data.total_baseline_power.toFixed(2)}</h3>
                    </div>
                </div>
            </div>
            <div class="col" style="flex: 1; min-width: 200px;">
                <div class="card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; border: none;">
                    <div class="card-body" style="padding: 1.5rem;">
                        <h6 style="opacity: 0.9; margin-bottom: 0.5rem; font-size: 0.875rem;">Optimized Power</h6>
                        <h3 style="margin: 0; font-weight: 700;">${data.total_optimized_power.toFixed(2)}</h3>
                    </div>
                </div>
            </div>
        `;
        summaryCards.innerHTML = cardsHtml;
        summaryCards.style.display = 'flex';

        // Build detailed allocation table
        allResultsData = [];
        let tableHtml = `
            <div style="overflow-x: auto;">
                <table class="table table-striped" style="min-width: 800px;">
                    <thead style="background-color: #f8f9fa; position: sticky; top: 0;">
                        <tr>
                            <th style="padding: 1rem;">Brand</th>
                            <th style="padding: 1rem; text-align: right;">Quarter</th>
                            <th style="padding: 1rem; text-align: right;">Total Budget</th>
                            ${!usedFallback ? '<th style="padding: 1rem; text-align: right;">PayTV Budget</th><th style="padding: 1rem; text-align: right;">PayTV %</th><th style="padding: 1rem; text-align: right;">Wholesalers Budget</th><th style="padding: 1rem; text-align: right;">Wholesalers %</th>' : ''}
                            <th style="padding: 1rem; text-align: right;">Baseline Power</th>
                            <th style="padding: 1rem; text-align: right;">Optimized Power</th>
                            <th style="padding: 1rem; text-align: right;">Power Gain</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        const quarters = data.quarters || ['2024 Q3', '2024 Q4', '2025 Q1', '2025 Q2'];
        const brands = data.brands || Object.keys(data.optimal_allocation || data.budget_allocation || {});

        brands.forEach(brand => {
            quarters.forEach((quarter, qIdx) => {
                const brandBudget = data.budget_allocation?.[brand] || 0;
                const quarterBudget = brandBudget / quarters.length;
                
                let paytvBudget = 0, wholesalersBudget = 0, paytvPct = 0, wholesalersPct = 0;
                
                if (!usedFallback && data.optimal_allocation?.[brand]) {
                    const allocation = data.optimal_allocation[brand];
                    paytvBudget = (allocation.paytv || 0) / quarters.length;
                    wholesalersBudget = (allocation.wholesalers || 0) / quarters.length;
                    paytvPct = quarterBudget > 0 ? (paytvBudget / quarterBudget * 100) : 0;
                    wholesalersPct = quarterBudget > 0 ? (wholesalersBudget / quarterBudget * 100) : 0;
                }

                const baselinePower = data.baseline_power?.[brand]?.[qIdx] || 0;
                const optimizedPower = data.optimized_power?.[brand]?.[qIdx] || 0;
                const powerGain = optimizedPower - baselinePower;
                const powerGainPct = baselinePower > 0 ? (powerGain / baselinePower * 100) : 0;

                // Store for CSV export
                const row = {
                    Brand: brand,
                    Quarter: quarter,
                    'Total Budget': quarterBudget,
                    'Baseline Power': baselinePower,
                    'Optimized Power': optimizedPower,
                    'Power Gain': powerGain,
                    'Power Gain %': powerGainPct
                };

                if (!usedFallback) {
                    row['PayTV Budget'] = paytvBudget;
                    row['PayTV %'] = paytvPct;
                    row['Wholesalers Budget'] = wholesalersBudget;
                    row['Wholesalers %'] = wholesalersPct;
                }

                allResultsData.push(row);

                const gainColor = powerGain >= 0 ? '#10b981' : '#ef4444';
                const paytvBadgeClass = paytvPct <= 50 ? 'bg-success' : 'bg-warning';

                tableHtml += `
                    <tr>
                        <td style="padding: 0.75rem;"><strong>${brand}</strong></td>
                        <td style="padding: 0.75rem; text-align: right;">${quarter}</td>
                        <td style="padding: 0.75rem; text-align: right;">$${quarterBudget.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        ${!usedFallback ? `
                            <td style="padding: 0.75rem; text-align: right;">$${paytvBudget.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                            <td style="padding: 0.75rem; text-align: right;"><span class="badge ${paytvBadgeClass}">${paytvPct.toFixed(1)}%</span></td>
                            <td style="padding: 0.75rem; text-align: right;">$${wholesalersBudget.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                            <td style="padding: 0.75rem; text-align: right;">${wholesalersPct.toFixed(1)}%</td>
                        ` : ''}
                        <td style="padding: 0.75rem; text-align: right;">${baselinePower.toFixed(2)}</td>
                        <td style="padding: 0.75rem; text-align: right;"><strong>${optimizedPower.toFixed(2)}</strong></td>
                        <td style="padding: 0.75rem; text-align: right; color: ${gainColor}; font-weight: 600;">
                            ${powerGain >= 0 ? '+' : ''}${powerGain.toFixed(2)} (${powerGainPct >= 0 ? '+' : ''}${powerGainPct.toFixed(1)}%)
                        </td>
                    </tr>
                `;
            });
        });

        tableHtml += `
                    </tbody>
                </table>
            </div>
        `;

        // Add constraints info
        if (!data.constraints_satisfied && data.constraint_violations?.length > 0) {
            tableHtml += `
                <div class="alert alert-warning mt-3">
                    <strong>⚠ Constraint Violations:</strong>
                    <ul class="mb-0 mt-2">
                        ${data.constraint_violations.map(v => `<li>${v}</li>`).join('')}
                    </ul>
                </div>
            `;
        } else {
            tableHtml += `
                <div class="alert alert-success mt-3" style="margin-bottom: 0;">
                    <strong>✓ All Constraints Satisfied</strong>
                </div>
            `;
        }

        resultsTable.innerHTML = tableHtml;
        
        // Initialize filters
        if (brands.length > 0) {
            const brandSelect = document.getElementById('filterBrand');
            brandSelect.innerHTML = '<option value="All">All Brands</option>' +
                brands.map(b => `<option value="${b}">${b}</option>`).join('');
            document.getElementById('filtersRow').style.display = 'flex';
        }

        // Show results
        resultsSection.style.display = 'block';

        // Display power comparison chart
        if (data.baseline_power && data.optimized_power) {
            displayBrandPowerComparison(data.baseline_power, data.optimized_power, data.power_uplift);
            chartCard.style.display = 'block';
        }
    }

    function displayBrandPowerComparison(baseline, optimized, uplift) {
        const brands = Object.keys(baseline);
        const quarters = ['Q3 2024', 'Q4 2024', 'Q1 2025', 'Q2 2025'];
        const traces = [];

        brands.forEach((brand) => {
            traces.push({
                x: quarters,
                y: baseline[brand],
                mode: 'lines+markers',
                name: `${brand} - Baseline`,
                line: { width: 3 },
                marker: { size: 8 }
            });

            traces.push({
                x: quarters,
                y: optimized[brand],
                mode: 'lines+markers',
                name: `${brand} - Optimized`,
                line: { width: 3, dash: 'dash' },
                marker: { size: 8, symbol: 'diamond' }
            });
        });

        const layout = {
            title: 'Baseline vs Optimized Power by Quarter',
            xaxis: { title: 'Quarter' },
            yaxis: { title: 'Brand Power' },
            height: 500,
            hovermode: 'x unified',
            showlegend: true
        };

        // Create chart container if it doesn't exist
        let chartContainer = document.getElementById('powerChart');
        if (!chartContainer) {
            chartContainer = document.createElement('div');
            chartContainer.id = 'powerChart';
            chartContainer.style.marginTop = '2rem';
            document.querySelector('#resultsSection .card-body').appendChild(chartContainer);
        }

        Plotly.newPlot('powerChart', traces, layout);
    }

    function displayPowerComparison(baseline, simulated, quarters) {
        const brands = Object.keys(baseline);
        const traces = [];

        brands.forEach((brand, i) => {
            traces.push({
                x: quarters,
                y: baseline[brand],
                mode: 'lines+markers',
                name: `${brand} - Baseline`,
                line: { width: 3 },
                marker: { size: 8 }
            });

            traces.push({
                x: quarters,
                y: simulated[brand],
                mode: 'lines+markers',
                name: `${brand} - Optimized`,
                line: { width: 3, dash: 'dash' },
                marker: { size: 8, symbol: 'diamond' }
            });
        });

        const layout = {
            title: 'Baseline vs Optimized Power Forecast',
            xaxis: { title: 'Quarter' },
            yaxis: { title: 'Brand Power' },
            height: 500,
            hovermode: 'x unified'
        };

        // Create a container for the chart if it doesn't exist
        let chartContainer = document.getElementById('powerChart');
        if (!chartContainer) {
            chartContainer = document.createElement('div');
            chartContainer.id = 'powerChart';
            chartContainer.style.marginTop = '2rem';
            document.querySelector('#resultsSection .card-body').appendChild(chartContainer);
        }

        Plotly.newPlot('powerChart', traces, layout);
    }

    function initFilters(rows) {
        const filtersRow = document.getElementById('filtersRow');
        if (filtersRow) filtersRow.style.display = 'flex';

        const brandSel = document.getElementById('filterBrand');
        const yearSel = document.getElementById('filterYear');

        const unique = (arr) => Array.from(new Set(arr));
        const brands = ['All'].concat(unique(rows.map(r => String(r.brand))).sort());
        const weeks = unique(rows.map(r => parseInt(r.week))).sort((a, b) => a - b);
        const quarters = ['All'];
        // Map weeks to quarters (12 weeks per quarter)
        for (let q = 1; q <= 4; q++) {
            quarters.push(`Q${q}`);
        }

        const setOptions = (sel, values) => {
            if (!sel) return;
            sel.innerHTML = values.map(v => `<option value="${v}">${v}</option>`).join('');
        };

        setOptions(brandSel, brands);
        setOptions(yearSel, quarters);

        const onChange = () => displayDataTable({ data: originalDataRows, columns: originalColumns }, document.getElementById('budgetAmount')?.value || '');
        if (brandSel) brandSel.addEventListener('change', onChange);
        if (yearSel) yearSel.addEventListener('change', onChange);
    }

    function resetFilters() {
        const brandSel = document.getElementById('filterBrand');
        const quarterSel = document.getElementById('filterQuarter');
        if (brandSel) brandSel.value = 'All';
        if (quarterSel) quarterSel.value = 'All';
        
        // Re-render table without filters
        if (optimizationResult) {
            displayBrandPowerResults(optimizationResult, document.getElementById('budgetAmount')?.value || '');
        }
    }

    function downloadOptimizedCSV() {
        if (!allResultsData || allResultsData.length === 0) {
            alert('No data available. Please run optimization first.');
            return;
        }

        console.log('Downloading optimized allocation CSV...');

        // Get column names from first row
        const columns = Object.keys(allResultsData[0]);
        let csvContent = columns.join(',') + '\n';

        allResultsData.forEach(row => {
            const values = columns.map(col => {
                const value = row[col];
                // Escape commas and quotes in CSV
                if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                    return '"' + value.replace(/"/g, '""') + '"';
                }
                // Format numbers
                if (typeof value === 'number') {
                    return value.toFixed(2);
                }
                return value || '';
            });
            csvContent += values.join(',') + '\n';
        });

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const timestamp = new Date().toISOString().slice(0,10);
        a.download = `optimized_allocation_${timestamp}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
        console.log('CSV download initiated');
    }
</script>

<style>
    .spinner-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock %}
