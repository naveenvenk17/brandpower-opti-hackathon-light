{% extends "base.html" %}

{% block title %}Home - BrandCompass.ai{% endblock %}

{% block content %}
<div class="container fade-in">
    <div class="hero">
        <h1 class="hero-title">BrandCompass.ai</h1>
        <p class="hero-subtitle">Navigate Your Brand's Power with Precision</p>
    </div>

    <section class="mb-5">
        <h2 class="section-header">Select Country</h2>
        <p class="mb-3">Choose your target market for brand power analysis:</p>

        <div class="country-grid">
            <div class="country-card" onclick="selectCountry('Brazil')">
                <div class="country-flag"></div>
                <div class="country-name">Brazil</div>
            </div>

            <div class="country-card" onclick="selectCountry('Colombia')">
                <div class="country-flag"></div>
                <div class="country-name">Colombia</div>
            </div>

            <div class="country-card" onclick="selectCountry('US')">
                <div class="country-flag"></div>
                <div class="country-name">USA</div>
            </div>
        </div>

        <div id="selectedCountryAlert" class="alert alert-success mt-3" style="display:none;">
            <strong>Selected:</strong> <span id="selectedCountryName"></span>
        </div>
    </section>

    <section class="mb-5 text-center">
        <h2 class="section-header">Choose Mode</h2>
        <div class="card" style="max-width: 700px; margin: 0 auto;">
            <div class="card-body">
                <div id="modeRequirementAlert" class="alert alert-warning" style="display:none;">
                    <strong>Requirement:</strong>
                    <ul class="mt-2 mb-0" style="padding-left: 1.5rem; text-align: left;">
                        <li>Select a country first</li>
                    </ul>
                </div>

                <div style="display:flex; gap: 1rem; flex-wrap: wrap; justify-content:center;">
                    <button class="btn btn-primary btn-slim" style="min-width: 180px;" onclick="chooseMode('simulator')"
                        id="simulatorBtn" disabled>Simulator</button>
                    <button class="btn btn-secondary btn-slim" style="min-width: 180px;"
                        onclick="chooseMode('optimizer')" id="optimizerBtn" disabled>Optimizer</button>
                </div>

                <p class="mt-3 text-muted" id="modeHint" style="display:none;">Upload your data below to continue...</p>
            </div>
        </div>
    </section>

    <section class="mb-5">
        <h2 class="section-header">Upload Data</h2>

        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">Upload Your Brand Data</div>
                <div class="card-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-text">
                                <strong>Choose a CSV file or drag and drop</strong>
                            </div>
                            <p class="text-muted mb-3">Upload your brand marketing data</p>
                            <input type="file" id="fileInput" name="file" accept=".csv" class="form-control-slim"
                                onchange="handleFileSelect(event)">
                        </div>
                    </form>

                    <div id="uploadStatus" class="mt-3"></div>
                    <div id="uploadedFileInfo" class="alert alert-success mt-3" style="display:none;">
                        <strong>✓ File uploaded:</strong> <span id="uploadedFileName"></span>
                        <br>
                        <small>Rows: <span id="uploadedRows">0</span> | Columns: <span id="uploadedCols">0</span></small>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Download Template</div>
                <div class="card-body">
                    <p class="mb-3">Not sure about the format? Download our CSV template with sample data:</p>

                    <a href="/download_template" class="btn btn-accent btn-slim mb-3"
                        style="display: block; text-align: center;">Download CSV Template</a>

                    <div class="alert alert-info">
                        <strong>Template includes:</strong>
                        <ul class="mt-2 mb-0" style="padding-left: 1.5rem;">
                            <li>Brand identifiers</li>
                            <li>Time period columns</li>
                            <li>Marketing channel data</li>
                            <li>Sample values for reference</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<style>
    .text-muted {
        color: var(--medium-gray);
    }

    .upload-area {
        cursor: pointer;
        padding: 1.5rem;
    }

    .upload-area:hover {
        border-color: var(--accent-yellow);
    }

    .upload-text {
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
    }

    .form-control-slim,
    #fileInput {
        margin-top: 0.75rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 6px;
    }

    .btn-slim {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .card-header {
        font-size: 1rem;
        padding: 0.75rem 1.25rem;
    }
</style>

<script>
    // --- Session state (no auto-persistence) ---
    let selectedCountry = null;
    let uploadedFileInfo = null;
    let chosenMode = null;

    function updateUIFromState() {
        // Selected country alert
        const selectedCountryAlert = document.getElementById('selectedCountryAlert');
        const selectedCountryName = document.getElementById('selectedCountryName');
        const simulatorBtn = document.getElementById('simulatorBtn');
        const optimizerBtn = document.getElementById('optimizerBtn');
        const modeRequirementAlert = document.getElementById('modeRequirementAlert');

        if (selectedCountry) {
            selectedCountryAlert.style.display = 'block';
            selectedCountryName.textContent = selectedCountry;
            document.body.dataset.selectedCountry = selectedCountry;
            simulatorBtn.disabled = false;
            optimizerBtn.disabled = false;
            modeRequirementAlert.style.display = 'none';
        } else {
            selectedCountryAlert.style.display = 'none';
            simulatorBtn.disabled = true;
            optimizerBtn.disabled = true;
            modeRequirementAlert.style.display = 'block';
        }

        // Uploaded file info
        const uploadedInfoDiv = document.getElementById('uploadedFileInfo');
        if (uploadedFileInfo && uploadedFileInfo.success) {
            uploadedInfoDiv.style.display = 'block';
            document.getElementById('uploadedFileName').textContent = uploadedFileInfo.filename;
            document.getElementById('uploadedRows').textContent = uploadedFileInfo.rows || 0;
            document.getElementById('uploadedCols').textContent = uploadedFileInfo.cols || 0;
        } else {
            uploadedInfoDiv.style.display = 'none';
        }
    }

    function chooseMode(mode) {
        chosenMode = mode;
        const hint = document.getElementById('modeHint');
        if (hint) hint.style.display = 'block';
        const fileInputEl = document.getElementById('fileInput');
        if (fileInputEl) fileInputEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function selectCountry(country) {
        // Store in session variable only (not persisted)
        selectedCountry = country;
        fetch('/select_country', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'country=' + encodeURIComponent(country)
        }).finally(() => {
            updateUIFromState();
        });
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        const statusDiv = document.getElementById('uploadStatus');
        statusDiv.innerHTML = '<div class="spinner"></div><p class="text-center">Uploading...</p>';

        fetch('/upload', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <strong>✓ Upload successful!</strong><br>
                    File: ${data.filename}<br>
                    Rows: ${data.rows} | Columns: ${data.cols}
                </div>
            `;
                    // Store in session variable only (not persisted)
                    uploadedFileInfo = data;
                    updateUIFromState();

                    // Redirect based on chosen mode
                    setTimeout(() => {
                        if (chosenMode === 'optimizer') {
                            window.location.href = '/optimization';
                        } else {
                            window.location.href = '/analysis';
                        }
                    }, 800);
                } else {
                    statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    <strong>✗ Upload failed:</strong> ${data.error}
                </div>
            `;
                }
            })
            .catch(error => {
                statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <strong>✗ Error:</strong> ${error.message}
            </div>
        `;
            });
    }

    // Drag and drop functionality
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--accent-yellow)';
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.borderColor = 'var(--primary-blue-light)';
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--primary-blue-light)';

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect({ target: { files: files } });
        }
    });

    // No automatic state restoration - user must explicitly select country and upload file
</script>
{% endblock %}