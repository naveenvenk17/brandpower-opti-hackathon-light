{% extends "base.html" %}

{% block title %}Analysis - BrandCompass.ai{% endblock %}

{% block content %}
<style>
    /* Override container constraints for full-width layout */
    body {
        margin: 0;
        padding: 0;
    }

    /* Tooltip styles for grouped columns */
    .grouped-column-header {
        position: relative;
        cursor: help;
    }

    .tooltip-hover {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #1f2937;
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        white-space: nowrap;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
        margin-bottom: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .tooltip-hover::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: #1f2937;
    }

    .grouped-column-header:hover .tooltip-hover {
        opacity: 1;
    }

    .info-icon {
        font-size: 0.8em;
        color: #6b7280;
        margin-left: 4px;
        font-weight: normal;
    }

    .main-content {
        padding: 0 !important;
    }

    .page-layout {
        display: flex;
        min-height: 100vh;
        width: 100%;
        margin: 0;
        padding: 0;
        margin-top: -2rem;
    }

    .left-sidebar {
        width: 280px;
        background: #f9fafb;
        border-right: 1px solid #e5e7eb;
        padding: 1.5rem 1rem;
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        overflow-y: auto;
        z-index: 100;
    }

    .main-content-wide {
        flex: 1;
        margin-left: 280px;
        padding: 2rem;
        width: calc(100% - 280px);
    }

    .sidebar-section-name {
        font-size: 0.85rem;
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .scenario-item {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }

    .scenario-item:hover {
        border-color: #B5942F;
        box-shadow: 0 4px 8px rgba(181, 148, 47, 0.15);
        transform: translateY(-2px);
    }

    .scenario-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: #B5942F;
        border-radius: 8px 0 0 8px;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .scenario-item:hover::before {
        opacity: 1;
    }

    .scenario-name {
        font-weight: 600;
        color: #111827;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .scenario-timestamp {
        font-size: 0.7rem;
        color: #6b7280;
        margin-bottom: 0.75rem;
    }

    .scenario-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
    }

    .scenario-load-btn {
        flex: 1;
        padding: 0.4rem 0.75rem;
        font-size: 0.8rem;
        background: #B5942F;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }

    .scenario-load-btn:hover {
        background: #9d7d28;
        transform: scale(1.05);
    }

    .scenario-delete-btn {
        padding: 0.4rem 0.75rem;
        font-size: 0.8rem;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .scenario-delete-btn:hover {
        background: #dc2626;
    }

    .experiments-empty {
        text-align: center;
        padding: 2rem 1rem;
        color: #9ca3af;
        font-size: 0.875rem;
        font-style: italic;
    }

    @media (max-width: 1024px) {
        .left-sidebar {
            width: 240px;
        }

        .main-content-wide {
            margin-left: 240px;
            width: calc(100% - 240px);
        }
    }
</style>

<div class="page-layout">
    <!-- Left Sidebar -->
    <div class="left-sidebar">
        <div style="text-align: center; padding: 1.5rem 0; border-bottom: 2px solid #e5e7eb; margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.5rem; font-weight: 700; color: #111827; margin: 0;">BrandCompass.ai</h2>
        </div>

        <div class="sidebar-section-name">Your experiments</div>
        <div id="sidebarScenariosList">
            <div class="experiments-empty">No experiments saved yet</div>
        </div>

        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
            <button class="btn btn-secondary btn-block" onclick="exportAll()" style="margin-bottom: 0.5rem;">Export
                All</button>
            <button class="btn btn-secondary btn-block" onclick="clearAll()">Clear All</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content-wide">
        <h1 class="hero-title text-center mb-4">Brand Power Analysis</h1>





        <section class="mb-5">
            <h2 class="section-header">Adjust Marketing Spend</h2>

            <div class="card">
                <div class="card-body">
                    <div style="display:flex; gap:1rem; align-items:center; flex-wrap: wrap; margin-bottom: 0.75rem;">
                        <!-- Brand Filter Multi-Select -->
                        <div class="multi-select-container" data-filter="brand">
                            <button class="multi-select-trigger" type="button" aria-haspopup="listbox"
                                aria-expanded="false">
                                <span class="multi-select-value">Select brands</span>
                                <span class="multi-select-icon">▼</span>
                            </button>
                            <div class="multi-select-dropdown">
                                <div class="multi-select-actions">
                                    <button class="filter-action-btn" onclick="selectAllFilter('brand', event)">Select
                                        All</button>
                                    <button class="filter-action-btn"
                                        onclick="clearFilter('brand', event)">Clear</button>
                                </div>
                                <div class="multi-select-search">
                                    <input type="text" placeholder="Search brands..." data-search="brand">
                                </div>
                                <div class="multi-select-options" role="listbox">
                                    {% set default_brand = 'AGUILA' %}
                                    {% for brand in brands %}
                                    <div class="multi-select-option {% if brand|upper == default_brand %}selected{% endif %}"
                                        data-value="{{ brand }}" data-filter-type="brand" role="option">
                                        <div class="multi-select-checkbox"></div>
                                        <span>{{ brand }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Year Filter Multi-Select -->
                        <div class="multi-select-container" data-filter="year">
                            <button class="multi-select-trigger" type="button" aria-haspopup="listbox"
                                aria-expanded="false">
                                <span class="multi-select-value">Select years</span>
                                <span class="multi-select-icon">▼</span>
                            </button>
                            <div class="multi-select-dropdown">
                                <div class="multi-select-actions">
                                    <button class="filter-action-btn" onclick="selectAllFilter('year', event)">Select
                                        All</button>
                                    <button class="filter-action-btn"
                                        onclick="clearFilter('year', event)">Clear</button>
                                </div>
                                <div class="multi-select-search">
                                    <input type="text" placeholder="Search years..." data-search="year">
                                </div>
                                <div class="multi-select-options" role="listbox">
                                    {% for year in years %}
                                    <div class="multi-select-option {% if year == 2024 %}selected{% endif %}"
                                        data-value="{{ year }}" data-filter-type="year" role="option">
                                        <div class="multi-select-checkbox"></div>
                                        <span>{{ year }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Month Filter Multi-Select -->
                        <div class="multi-select-container" data-filter="month">
                            <button class="multi-select-trigger" type="button" aria-haspopup="listbox"
                                aria-expanded="false">
                                <span class="multi-select-value">Select months</span>
                                <span class="multi-select-icon">▼</span>
                            </button>
                            <div class="multi-select-dropdown">
                                <div class="multi-select-actions">
                                    <button class="filter-action-btn" onclick="selectAllFilter('month', event)">Select
                                        All</button>
                                    <button class="filter-action-btn"
                                        onclick="clearFilter('month', event)">Clear</button>
                                </div>
                                <div class="multi-select-search">
                                    <input type="text" placeholder="Search months..." data-search="month">
                                </div>
                                <div class="multi-select-options" role="listbox">
                                    {% set month_names = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep',
                                    'Oct', 'Nov', 'Dec'] %}
                                    {% for month in months %}
                                    <div class="multi-select-option {% if month == 7 %}selected{% endif %}"
                                        data-value="{{ month }}" data-filter-type="month" role="option">
                                        <div class="multi-select-checkbox"></div>
                                        <span>{{ month }} - {{ month_names[month - 1] if month >= 1 and month <= 12
                                                else 'Month ' ~ month }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Week Filter Multi-Select -->
                        <div class="multi-select-container" data-filter="week">
                            <button class="multi-select-trigger" type="button" aria-haspopup="listbox"
                                aria-expanded="false">
                                <span class="multi-select-value">Select weeks</span>
                                <span class="multi-select-icon">▼</span>
                            </button>
                            <div class="multi-select-dropdown">
                                <div class="multi-select-actions">
                                    <button class="filter-action-btn" onclick="selectAllFilter('week', event)">Select
                                        All</button>
                                    <button class="filter-action-btn"
                                        onclick="clearFilter('week', event)">Clear</button>
                                </div>
                                <div class="multi-select-search">
                                    <input type="text" placeholder="Search weeks..." data-search="week">
                                </div>
                                <div class="multi-select-options" role="listbox">
                                    {% for week in weeks %}
                                    <div class="multi-select-option" data-value="{{ week }}" data-filter-type="week"
                                        role="option">
                                        <div class="multi-select-checkbox"></div>
                                        <span>Week {{ week }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <label style="display:flex; align-items:center; gap:0.4rem; margin-right: 1rem;">
                            <input type="checkbox" id="percentageToggle"> <span>Show as Percentage</span>
                        </label>

                        <button class="btn btn-secondary" onclick="resetAllFilters()">Reset All Changes</button>
                    </div>

                    <div id="editableTable" class="table-container" style="max-height: 420px; overflow: auto;"></div>
                </div>
            </div>
        </section>

        <section class="mb-5">
            <h2 class="section-header">Calculate Brand Power</h2>

            <div class="card">
                <div class="card-body">
                    <div style="display: flex; gap: 2rem; align-items: center;">
                        <div style="flex: 0 0 auto;">
                            <button class="btn btn-primary" style="padding: 0.75rem 2rem; font-size: 1rem;"
                                onclick="calculatePower()">Calculate Brand Power</button>
                        </div>
                        <div style="flex: 1;">
                            <div id="changesSummary"
                                style="background: #f9fafb; padding: 1rem; border-radius: 6px; border-left: 3px solid #1e50a2;">
                                <strong
                                    style="color: #374151; font-size: 0.95rem; margin-bottom: 0.75rem; display: block;">Changes
                                    Summary:</strong>
                                <div id="changesList" style="font-size: 0.875rem; color: #6b7280;">
                                    <p style="text-align: center; color: #9ca3af; font-style: italic; margin: 0;">No
                                        changes made yet. Edit values in the table above to see changes here.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="resultsSection" class="mb-5" style="display: none;">
            <h2 class="section-header">Results</h2>

            <div class="card">
                <div class="card-header">Quarterly Brand Power Forecast</div>
                <div class="card-body">
                    <div id="resultsTable" style="max-height: 450px; overflow-y: auto;"></div>
                    <div style="display: flex; gap: 1rem; align-items: center; margin-top: 1rem;">
                        <label class="form-label" style="margin: 0;">Filter brands:</label>
                        <div class="multi-select-container" data-filter="chart-brand">
                            <button class="multi-select-trigger" type="button" aria-haspopup="listbox"
                                aria-expanded="false">
                                <span class="multi-select-value">Select brands for chart</span>
                                <span class="multi-select-icon">▼</span>
                            </button>
                            <div class="multi-select-dropdown">
                                <div class="multi-select-actions">
                                    <button class="filter-action-btn"
                                        onclick="selectAllFilter('chart-brand', event)">Select All</button>
                                    <button class="filter-action-btn"
                                        onclick="clearFilter('chart-brand', event)">Clear</button>
                                </div>
                                <div class="multi-select-search">
                                    <input type="text" placeholder="Search brands..." data-search="chart-brand">
                                </div>
                                <div class="multi-select-options" role="listbox" id="chartBrandOptions">
                                    <!-- Options populated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="chartContainer" class="mt-4"></div>
                </div>
            </div>
        </section>

        <section class="mb-5">
            <h2 class="section-header">Save Current Experiment</h2>

            <div class="card">
                <div class="card-body">
                    <div style="display: flex; gap: 1rem; align-items: flex-end;">
                        <div class="form-group" style="flex: 1; margin: 0;">
                            <label class="form-label">Experiment Name:</label>
                            <input type="text" id="experimentName" class="form-control" placeholder="Experiment_1">
                        </div>
                        <div style="flex: 0 0 auto;">
                            <button class="btn btn-accent" onclick="saveExperiment()"
                                style="background: #B5942F; border-color: #B5942F; padding: 0.625rem 2rem;"
                                onmouseover="this.style.background='#9d7d28'"
                                onmouseout="this.style.background='#B5942F'">Save Experiment</button>
                        </div>
                    </div>
                    <div id="saveStatus" class="mt-3"></div>
                </div>
            </div>
        </section>

        <div class="text-center mb-5">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to Home</a>
        </div>
    </div>
</div>

<style>
    input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        height: 8px;
        background: linear-gradient(to right, var(--danger) 0%, var(--medium-gray) 50%, var(--success) 100%);
        border-radius: 5px;
        outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: var(--primary-blue);
        border: 3px solid var(--white);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: var(--shadow-md);
    }

    input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: var(--primary-blue);
        border: 3px solid var(--white);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: var(--shadow-md);
    }
</style>

<!-- Server-provided data for JS -->
<div id="server-data" data-table-columns='{{ table_columns | tojson | safe if table_columns is defined else "[]" }}'
    data-table-rows='{{ table_rows | tojson | safe if table_rows is defined else "[]" }}'
    data-feature-columns='{{ feature_columns | tojson | safe if feature_columns is defined else "[]" }}'
    data-channel-groups='{{ channel_groups | tojson | safe if channel_groups is defined else "{}" }}'>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    let baselineData = null;
    let simulatedData = null;
    let historicalData = null;
    let historicalQuarters = null;
    let currentChanges = {};
    const __serverEl = document.getElementById('server-data');
    let tableColumns = JSON.parse((__serverEl && __serverEl.dataset.tableColumns) ? __serverEl.dataset.tableColumns : '[]');
    let tableRows = JSON.parse((__serverEl && __serverEl.dataset.tableRows) ? __serverEl.dataset.tableRows : '[]');
    let featureColumns = JSON.parse((__serverEl && __serverEl.dataset.featureColumns) ? __serverEl.dataset.featureColumns : '[]');
    let channelGroups = JSON.parse((__serverEl && __serverEl.dataset.channelGroups) ? __serverEl.dataset.channelGroups : '{}');

    function renderEditableTable() {
        const container = document.getElementById('editableTable');
        if (!container) return;

        const featuresSet = new Set(featureColumns);
        const isPercentage = document.getElementById('percentageToggle').checked;

        // Get filter values
        const selBrands = multiSelects['brand'] ? multiSelects['brand'].getSelectedValues() : [];
        const selYears = multiSelects['year'] ? multiSelects['year'].getSelectedValues().map(v => parseInt(v)) : [];
        const selMonths = multiSelects['month'] ? multiSelects['month'].getSelectedValues().map(v => parseInt(v)) : [];
        const selWeeks = multiSelects['week'] ? multiSelects['week'].getSelectedValues().map(v => parseInt(v)) : [];

        // Determine ID column names (flexible)
        const brandCol = tableColumns.find(c => c.toLowerCase() === 'brand') || 'brand';
        const yearCol = tableColumns.find(c => c.toLowerCase() === 'year') || 'year';
        const monthCol = tableColumns.find(c => c.toLowerCase() === 'month') || 'month';
        const weekCol = tableColumns.find(c => c.toLowerCase() === 'week_of_month' || c.toLowerCase() === 'week') || 'week_of_month' || 'Week';

        // First pass: filter rows and calculate column totals for percentage mode
        const filteredRowIndices = [];
        const columnTotals = {};

        tableRows.forEach((row, rIdx) => {
            // Apply filters
            let show = true;
            if (selBrands.length > 0 && brandCol && row[brandCol]) {
                show = show && selBrands.includes(String(row[brandCol]));
            }
            if (selYears.length > 0 && yearCol && row[yearCol]) {
                show = show && selYears.includes(parseInt(row[yearCol]));
            }
            if (selMonths.length > 0 && monthCol && row[monthCol]) {
                show = show && selMonths.includes(parseInt(row[monthCol]));
            }
            if (selWeeks.length > 0 && weekCol && row[weekCol]) {
                show = show && selWeeks.includes(parseInt(row[weekCol]));
            }

            if (show) {
                filteredRowIndices.push(rIdx);
                // Calculate totals for each optimizable column
                if (isPercentage) {
                    featureColumns.forEach(col => {
                        const val = parseFloat(row[col]) || 0;
                        columnTotals[col] = (columnTotals[col] || 0) + val;
                    });
                }
            }
        });

        // Second pass: build HTML with tooltips for grouped columns
        let html = '<table class="table table-striped"><thead><tr>';
        tableColumns.forEach(col => {
            // Check if this column is a grouped channel
            if (channelGroups[col]) {
                const components = channelGroups[col].map(c => {
                    // Format component names nicely (capitalize first letter, replace underscores)
                    return c.charAt(0).toUpperCase() + c.slice(1).replace(/_/g, ' ');
                }).join(', ');
                html += `<th class="grouped-column-header">
                    ${col}
                    <span class="info-icon">ⓘ</span>
                    <div class="tooltip-hover">Components: ${components}</div>
                </th>`;
            } else {
                html += `<th>${col}</th>`;
            }
        });
        html += '</tr></thead><tbody>';

        filteredRowIndices.forEach(rIdx => {
            const row = tableRows[rIdx];
            html += '<tr>';
            tableColumns.forEach(col => {
                const rawVal = row[col] !== undefined ? row[col] : '';
                const isEditable = featuresSet.has(col);

                if (isEditable && isPercentage) {
                    // Show as percentage
                    const numVal = parseFloat(rawVal) || 0;
                    const total = columnTotals[col] || 1;
                    const percentage = total > 0 ? (numVal / total * 100).toFixed(2) : '0.00';
                    html += `<td><input type="number" data-row="${rIdx}" data-col="${col}" value="${percentage}" class="form-control" style="min-width: 100px;" step="0.01" data-percentage="true" data-total="${total}"> <span style="font-size: 0.875rem; color: #6b7280;">%</span></td>`;
                } else if (isEditable) {
                    // Show as absolute value
                    html += `<td><input type="number" data-row="${rIdx}" data-col="${col}" value="${rawVal}" class="form-control" style="min-width: 100px;"></td>`;
                } else {
                    html += `<td>${rawVal}</td>`;
                }
            });
            html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;

        container.querySelectorAll('input[data-row]')?.forEach(input => {
            input.addEventListener('change', (e) => {
                const rowIndex = parseInt(e.target.getAttribute('data-row'));
                const colName = e.target.getAttribute('data-col');
                const inputVal = parseFloat(e.target.value);

                if (e.target.hasAttribute('data-percentage')) {
                    // Convert percentage back to absolute value
                    const total = parseFloat(e.target.getAttribute('data-total')) || 0;
                    const absoluteVal = (inputVal / 100) * total;
                    tableRows[rowIndex][colName] = isNaN(absoluteVal) ? 0 : absoluteVal;
                } else {
                    tableRows[rowIndex][colName] = isNaN(inputVal) ? 0 : inputVal;
                }

                // Update changes summary
                updateChangesSummary();
            });
        });
    }

    // Store original data for comparison
    let originalTableRows = null;

    function updateChangesSummary() {
        if (!originalTableRows) {
            originalTableRows = JSON.parse(JSON.stringify(tableRows));
        }

        const changesListEl = document.getElementById('changesList');
        if (!changesListEl) return;

        // Get filter values
        const selBrands = multiSelects['brand'] ? multiSelects['brand'].getSelectedValues() : [];
        const selYears = multiSelects['year'] ? multiSelects['year'].getSelectedValues().map(v => parseInt(v)) : [];
        const selMonths = multiSelects['month'] ? multiSelects['month'].getSelectedValues().map(v => parseInt(v)) : [];
        const selWeeks = multiSelects['week'] ? multiSelects['week'].getSelectedValues().map(v => parseInt(v)) : [];

        const brandCol = tableColumns.find(c => c.toLowerCase() === 'brand') || 'brand';
        const yearCol = tableColumns.find(c => c.toLowerCase() === 'year') || 'year';
        const monthCol = tableColumns.find(c => c.toLowerCase() === 'month') || 'month';
        const weekCol = tableColumns.find(c => c.toLowerCase() === 'week_of_month' || c.toLowerCase() === 'week') || 'week_of_month' || 'Week';

        // Filter function
        const matchesFilter = (row) => {
            let match = true;
            if (selBrands.length > 0 && brandCol && row[brandCol]) {
                match = match && selBrands.includes(String(row[brandCol]));
            }
            if (selYears.length > 0 && yearCol && row[yearCol]) {
                match = match && selYears.includes(parseInt(row[yearCol]));
            }
            if (selMonths.length > 0 && monthCol && row[monthCol]) {
                match = match && selMonths.includes(parseInt(row[monthCol]));
            }
            if (selWeeks.length > 0 && weekCol && row[weekCol]) {
                match = match && selWeeks.includes(parseInt(row[weekCol]));
            }
            return match;
        };

        // Calculate column sums
        const columnChanges = {};
        featureColumns.forEach(col => {
            let originalSum = 0;
            let currentSum = 0;

            originalTableRows.forEach((row, idx) => {
                if (matchesFilter(row)) {
                    originalSum += parseFloat(row[col]) || 0;
                }
            });

            tableRows.forEach((row, idx) => {
                if (matchesFilter(row)) {
                    currentSum += parseFloat(row[col]) || 0;
                }
            });

            const delta = currentSum - originalSum;
            if (Math.abs(delta) > 0.01) {
                const pctChange = originalSum !== 0 ? (delta / originalSum) * 100 : 0;
                columnChanges[col] = { delta, pctChange };
            }
        });

        // Display changes
        if (Object.keys(columnChanges).length === 0) {
            changesListEl.innerHTML = '<p style="text-align: center; color: #9ca3af; font-style: italic; margin: 0;">No changes made yet. Edit values in the table above to see changes here.</p>';
        } else {
            let html = '<table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">';
            html += '<thead><tr style="border-bottom: 2px solid #e5e7eb;">';
            html += '<th style="text-align: left; padding: 0.5rem; font-weight: 600; color: #374151;">Column Name</th>';
            html += '<th style="text-align: right; padding: 0.5rem; font-weight: 600; color: #374151;">Delta</th>';
            html += '</tr></thead><tbody>';

            Object.entries(columnChanges).forEach(([col, change]) => {
                const sign = change.delta >= 0 ? '+' : '';
                const color = change.delta >= 0 ? '#10b981' : '#ef4444';
                html += `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 0.5rem; color: #374151;">${col}</td>
                        <td style="padding: 0.5rem; text-align: right; color: ${color}; font-weight: 600;">
                            delta ${sign}${Math.round(change.delta).toLocaleString()} 
                            <span style="font-size: 0.85rem;">(${sign}${change.pctChange.toFixed(1)}%)</span>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            changesListEl.innerHTML = html;
        }
    }

    function togglePercentageView() {
        renderEditableTable();
    }

    function calculatePower() {
        const resultsSection = document.getElementById('resultsSection');
        resultsSection.style.display = 'none';

        const spinner = document.createElement('div');
        spinner.innerHTML = '<div class="spinner"></div><p class="text-center">Calculating brand power...</p>';
        document.getElementById('resultsTable').innerHTML = '';
        document.getElementById('resultsTable').appendChild(spinner);
        resultsSection.style.display = 'block';

        // gather filters from multi-select components
        const selBrands = multiSelects['brand'] ? multiSelects['brand'].getSelectedValues() : [];
        const selYears = multiSelects['year'] ? multiSelects['year'].getSelectedValues().map(v => parseInt(v)) : [];
        const selMonths = multiSelects['month'] ? multiSelects['month'].getSelectedValues().map(v => parseInt(v)) : [];
        const selWeeks = multiSelects['week'] ? multiSelects['week'].getSelectedValues().map(v => parseInt(v)) : [];

        fetch('{{ url_for("calculate") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                changes: currentChanges,
                filters: { brands: selBrands, years: selYears, months: selMonths, weeks: selWeeks },
                edited_rows: tableRows,
                columns: tableColumns
            })
        })
            .then(response => response.json())
            .then(data => {
                baselineData = data.baseline;
                simulatedData = data.simulated;
                historicalData = data.historical || {};
                historicalQuarters = data.historical_quarters || [];
                displayResults(data);
            })
            .catch(error => {
                document.getElementById('resultsTable').innerHTML = `
            <div class="alert alert-danger">
                <strong>✗ Error:</strong> ${error.message}
            </div>
        `;
            });
    }

    function displayResults(data) {
        const quarters = data.quarters;
        const baseline = data.baseline;
        const simulated = data.simulated;
        const historical = data.historical || {};
        const historicalQuarters = data.historical_quarters || [];

        console.log('=== DISPLAY RESULTS ===');
        console.log('Historical data received:', historical);
        console.log('Historical quarters received:', historicalQuarters);

        let tableHTML = '<div class="table-container"><table class="table table-striped"><thead><tr>';
        tableHTML += '<th>Brand</th>';
        quarters.forEach(q => {
            tableHTML += `<th>${q}</th>`;
        });
        tableHTML += '</tr></thead><tbody>';

        // Show ALL brands, not just filtered ones
        const allBrands = Object.keys(baseline);

        allBrands.forEach(brand => {
            tableHTML += `<tr><td><strong>${brand}</strong></td>`;

            baseline[brand].forEach((baseValue, i) => {
                const simValue = simulated[brand][i];
                const change = ((simValue - baseValue) / baseValue) * 100;
                const color = change >= 0 ? '#10b981' : '#ef4444';
                tableHTML += `<td style="text-align: left;">
                    <span style="font-weight: 600;">${simValue.toFixed(2)}</span>
                    <span style="font-size: 0.75rem; color: ${color}; margin-left: 0.5rem;">
                        ${change > 0 ? '+' : ''}${change.toFixed(1)}%
                    </span>
                </td>`;
            });

            tableHTML += '</tr>';
        });

        tableHTML += '</tbody></table></div>';
        document.getElementById('resultsTable').innerHTML = tableHTML;

        populateBrandFilter(Object.keys(baseline));
        createChart(baseline, simulated, quarters, historical, historicalQuarters);
    }

    function createChart(baseline, simulated, quarters, historical = {}, historicalQuarters = []) {
        const traces = [];

        // Defensive checks
        if (!baseline || typeof baseline !== 'object') {
            console.error('Baseline data is invalid:', baseline);
            return;
        }

        if (!simulated || typeof simulated !== 'object') {
            console.error('Simulated data is invalid:', simulated);
            return;
        }

        const selected = multiSelects['chart-brand'] ? multiSelects['chart-brand'].getSelectedValues() : [];
        const brandsToShow = selected.length ? selected : Object.keys(baseline);

        console.log('=== CHART DATA ===');
        console.log('Historical quarters:', historicalQuarters);
        console.log('Forecast quarters:', quarters);
        console.log('Brands to show:', brandsToShow);
        console.log('Baseline keys:', Object.keys(baseline));
        console.log('Simulated keys:', Object.keys(simulated));
        console.log('Historical keys:', Object.keys(historical));

        if (!brandsToShow || brandsToShow.length === 0) {
            console.error('No brands to show');
            return;
        }

        // Margin of error percentages for each quarter (starts at 0% for 2024 Q2)
        const marginOfError = {
            '2024 Q2': 0.00,  // 0% at intervention point
            '2024 Q3': 0.01,  // 1%
            '2024 Q4': 0.02,  // 2%
            '2025 Q1': 0.03,  // 3%
            '2025 Q2': 0.04   // 4%
        };

        brandsToShow.forEach((brand, i) => {
            // Historical data (pre-intervention) - DEEP BLUE solid line (thicker)
            const hasHistoricalData = historical && historical[brand] && historicalQuarters && historicalQuarters.length > 0;

            if (hasHistoricalData) {
                traces.push({
                    x: historicalQuarters,
                    y: historical[brand],
                    mode: 'lines+markers',
                    name: `${brand} - Historical`,
                    line: { width: 3, color: '#0072B2' },  // Deep Blue
                    marker: { size: 6, color: '#0072B2', symbol: 'circle' },
                    connectgaps: false
                });
                console.log(`${brand} Historical:`, historical[brand]);
            }

            // Baseline forecast (post-intervention) - AMBER solid line with margin of error
            if (baseline[brand] && Array.isArray(baseline[brand])) {
                let baselineX = quarters;
                let baselineY = baseline[brand];

                // Connect from 2024 Q2 (last historical point) with 0% error
                if (hasHistoricalData && historical[brand].length > 0) {
                    const lastHistoricalQ = historicalQuarters[historicalQuarters.length - 1];
                    const lastHistoricalValue = historical[brand][historical[brand].length - 1];

                    // Prepend 2024 Q2 connection point
                    baselineX = [lastHistoricalQ, ...quarters];
                    baselineY = [lastHistoricalValue, ...baseline[brand]];
                }

                // Calculate margin of error bounds (starts from 0% at 2024 Q2)
                const baselineLower = baselineY.map((val, idx) => {
                    const margin = marginOfError[baselineX[idx]] || 0;
                    return val * (1 - margin);
                });
                const baselineUpper = baselineY.map((val, idx) => {
                    const margin = marginOfError[baselineX[idx]] || 0;
                    return val * (1 + margin);
                });

                // Add lower bound (invisible line)
                traces.push({
                    x: baselineX,
                    y: baselineLower,
                    mode: 'lines',
                    name: `${brand} - Baseline Lower`,
                    line: { width: 0 },
                    showlegend: false,
                    hoverinfo: 'skip'
                });

                // Add upper bound with fill to create shaded region
                traces.push({
                    x: baselineX,
                    y: baselineUpper,
                    mode: 'lines',
                    name: `${brand} - Baseline Upper`,
                    line: { width: 0 },
                    fill: 'tonexty',
                    fillcolor: 'rgba(230, 159, 0, 0.2)',  // Amber with transparency
                    showlegend: false,
                    hoverinfo: 'skip'
                });

                // Add main baseline line on top
                traces.push({
                    x: baselineX,
                    y: baselineY,
                    mode: 'lines+markers',
                    name: `${brand} - Baseline Forecast`,
                    line: { width: 2, color: '#E69F00' },  // Amber
                    marker: { size: 6, color: '#E69F00', symbol: 'circle' },
                    connectgaps: true
                });
                console.log(`${brand} Baseline:`, baseline[brand]);
            } else {
                console.warn(`${brand} baseline data is missing or invalid`);
            }

            // Simulated forecast (post-intervention) - TEAL-GREEN solid line with margin of error
            if (simulated[brand] && Array.isArray(simulated[brand])) {
                let simulatedX = quarters;
                let simulatedY = simulated[brand];

                // Connect from 2024 Q2 (last historical point) with 0% error
                if (hasHistoricalData && historical[brand].length > 0) {
                    const lastHistoricalQ = historicalQuarters[historicalQuarters.length - 1];
                    const lastHistoricalValue = historical[brand][historical[brand].length - 1];

                    // Prepend 2024 Q2 connection point
                    simulatedX = [lastHistoricalQ, ...quarters];
                    simulatedY = [lastHistoricalValue, ...simulated[brand]];
                }

                // Calculate margin of error bounds (starts from 0% at 2024 Q2)
                const simulatedLower = simulatedY.map((val, idx) => {
                    const margin = marginOfError[simulatedX[idx]] || 0;
                    return val * (1 - margin);
                });
                const simulatedUpper = simulatedY.map((val, idx) => {
                    const margin = marginOfError[simulatedX[idx]] || 0;
                    return val * (1 + margin);
                });

                // Add lower bound (invisible line)
                traces.push({
                    x: simulatedX,
                    y: simulatedLower,
                    mode: 'lines',
                    name: `${brand} - Simulated Lower`,
                    line: { width: 0 },
                    showlegend: false,
                    hoverinfo: 'skip'
                });

                // Add upper bound with fill to create shaded region
                traces.push({
                    x: simulatedX,
                    y: simulatedUpper,
                    mode: 'lines',
                    name: `${brand} - Simulated Upper`,
                    line: { width: 0 },
                    fill: 'tonexty',
                    fillcolor: 'rgba(0, 158, 115, 0.2)',  // Teal-Green with transparency
                    showlegend: false,
                    hoverinfo: 'skip'
                });

                // Add main simulated line on top (NO uplift fill between baseline and simulated)
                traces.push({
                    x: simulatedX,
                    y: simulatedY,
                    mode: 'lines+markers',
                    name: `${brand} - Simulated`,
                    line: { width: 2, color: '#009E73' },  // Teal-Green
                    marker: { size: 6, color: '#009E73', symbol: 'circle' },
                    connectgaps: true
                    // NO fill property - removed uplift coloring
                });
                console.log(`${brand} Simulated:`, simulated[brand]);
            } else {
                console.warn(`${brand} simulated data is missing or invalid`);
            }
        });

        if (traces.length === 0) {
            console.error('No traces to plot');
            document.getElementById('chartContainer').innerHTML = '<div class="alert alert-warning">No data available to display chart</div>';
            return;
        }

        // Check if we have historical data
        const hasHistoricalData = historicalQuarters && historicalQuarters.length > 0;

        const layout = {
            title: {
                text: 'Brand Power: Historical & Forecast',
                font: {
                    size: 18,
                    family: 'Arial, sans-serif',
                    color: '#333'
                }
            },
            xaxis: {
                title: 'Quarter',
                type: 'category',
                showgrid: true,
                gridcolor: '#E0E0E0',  // Light gray gridlines
                gridwidth: 1
            },
            yaxis: {
                title: 'Power',
                showgrid: true,
                gridcolor: '#E0E0E0',  // Light gray gridlines
                gridwidth: 1
            },
            height: 600,
            plot_bgcolor: 'white',  // White background
            paper_bgcolor: 'white',  // White background
            hovermode: 'x unified',
            showlegend: true,
            legend: {
                x: 1.05,
                y: 1,
                bgcolor: 'rgba(255, 255, 255, 0.9)',
                bordercolor: '#E0E0E0',
                borderwidth: 1
            },
            dragmode: 'zoom',  // Enable zoom mode
            margin: {
                l: 80,
                r: 150,
                t: 80,
                b: 80
            }
        };

        // Configure chart to be responsive and allow zoom/pan
        const config = {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToAdd: ['pan2d', 'select2d', 'lasso2d'],
            modeBarButtonsToRemove: [],
            displaylogo: false,
            toImageButtonOptions: {
                format: 'png',
                filename: 'brand_power_forecast',
                height: 800,
                width: 1200,
                scale: 1
            }
        };

        // Add intervention line at 2024 Q2 - BURNT ORANGE dashed line
        if (hasHistoricalData) {
            layout.shapes = [
                {
                    type: 'line',
                    x0: '2024 Q2',
                    x1: '2024 Q2',
                    y0: 0,
                    y1: 1,
                    yref: 'paper',
                    xref: 'x',
                    line: {
                        color: '#D55E00',  // Burnt Orange
                        width: 2,
                        dash: 'dash'  // Dashed line
                    }
                }
            ];
            layout.annotations = [
                {
                    x: '2024 Q2',
                    y: 1.05,
                    yref: 'paper',
                    xref: 'x',
                    text: 'Intervention',
                    showarrow: false,
                    font: {
                        color: '#D55E00',  // Burnt Orange
                        size: 14,
                        family: 'Arial, sans-serif',
                        weight: 'bold'
                    },
                    xanchor: 'center',
                    yanchor: 'bottom'
                }
            ];
        }

        console.log('Plotting with', traces.length, 'traces');
        Plotly.newPlot('chartContainer', traces, layout, config);
    }

    function saveExperiment() {
        let name = document.getElementById('experimentName').value.trim();

        // If empty, use the placeholder value
        if (!name) {
            name = document.getElementById('experimentName').placeholder;
        }

        if (!name) {
            document.getElementById('saveStatus').innerHTML = `
            <div class="alert alert-warning">
                <strong>⚠ Please enter an experiment name.</strong>
            </div>
        `;
            return;
        }

        if (!baselineData || !simulatedData) {
            document.getElementById('saveStatus').innerHTML = `
            <div class="alert alert-warning">
                <strong>⚠ Please calculate results first.</strong>
            </div>
        `;
            return;
        }

        fetch('{{ url_for("save_experiment") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                baseline_data: baselineData,
                simulated_data: simulatedData,
                changes: currentChanges,
                user_entered_data: tableRows,
                table_columns: tableColumns,
                table_rows: tableRows
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('saveStatus').innerHTML = '';
                    // Update sidebar and set new default name
                    updateSidebarScenarios();
                }
            })
            .catch(error => {
                document.getElementById('saveStatus').innerHTML = `
            <div class="alert alert-danger">
                <strong>✗ Error:</strong> ${error.message}
            </div>
        `;
            });
    }

    function populateBrandFilter(brands) {
        const optionsContainer = document.getElementById('chartBrandOptions');
        if (!optionsContainer || !brands) return;

        optionsContainer.innerHTML = '';
        brands.forEach((b, index) => {
            const opt = document.createElement('div');
            // Only select the first brand by default
            opt.className = index === 0 ? 'multi-select-option selected' : 'multi-select-option';
            opt.setAttribute('data-value', b);
            opt.setAttribute('data-filter-type', 'chart-brand');
            opt.setAttribute('role', 'option');
            opt.innerHTML = `
                <div class="multi-select-checkbox"></div>
                <span>${b}</span>
            `;
            optionsContainer.appendChild(opt);
        });

        // Reinitialize the chart brand multi-select
        const chartBrandContainer = document.querySelector('[data-filter="chart-brand"]');
        if (chartBrandContainer) {
            // Remove old instance if exists
            if (multiSelects['chart-brand']) {
                delete multiSelects['chart-brand'];
            }

            // Create new instance
            multiSelects['chart-brand'] = new MultiSelect(chartBrandContainer);

            // Add change listener to all options
            optionsContainer.querySelectorAll('.multi-select-option').forEach(option => {
                option.addEventListener('click', () => {
                    setTimeout(() => {
                        if (baselineData && simulatedData) {
                            createChart(baselineData, simulatedData, ['2024 Q3', '2024 Q4', '2025 Q1', '2025 Q2'], historicalData || {}, historicalQuarters || []);
                        }
                    }, 50);
                });
            });
        }
    }

    // Multi-Select Dropdown Component Logic
    class MultiSelect {
        constructor(container) {
            this.container = container;
            this.trigger = container.querySelector('.multi-select-trigger');
            this.dropdown = container.querySelector('.multi-select-dropdown');
            this.valueElement = container.querySelector('.multi-select-value');
            this.searchInput = container.querySelector('[data-search]');
            this.options = container.querySelectorAll('.multi-select-option');

            this.init();
        }

        init() {
            // Toggle dropdown
            this.trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                this.toggle();
            });

            // Option selection
            this.options.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    option.classList.toggle('selected');
                    this.updateValue();
                });
            });

            // Search functionality
            if (this.searchInput) {
                this.searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    this.options.forEach(option => {
                        const text = option.textContent.toLowerCase();
                        option.style.display = text.includes(query) ? 'flex' : 'none';
                    });
                });
            }

            // Close on outside click
            document.addEventListener('click', (e) => {
                if (!this.container.contains(e.target)) {
                    this.close();
                }
            });

            // Initialize value
            this.updateValue();
        }

        toggle() {
            const isOpen = this.dropdown.classList.contains('open');
            if (isOpen) {
                this.close();
            } else {
                this.open();
            }
        }

        open() {
            this.dropdown.classList.add('open');
            this.trigger.setAttribute('aria-expanded', 'true');
            if (this.searchInput) this.searchInput.focus();
        }

        close() {
            this.dropdown.classList.remove('open');
            this.trigger.setAttribute('aria-expanded', 'false');
            if (this.searchInput) this.searchInput.value = '';
            // Reset search
            this.options.forEach(option => option.style.display = 'flex');
        }

        updateValue() {
            const selected = Array.from(this.options).filter(opt => opt.classList.contains('selected'));
            const count = selected.length;

            if (count === 0) {
                this.valueElement.textContent = this.valueElement.getAttribute('data-placeholder') || 'Select...';
                this.valueElement.classList.add('placeholder');
            } else if (count === 1) {
                this.valueElement.textContent = selected[0].textContent.trim();
                this.valueElement.classList.remove('placeholder');
            } else {
                this.valueElement.textContent = `${count} selected`;
                this.valueElement.classList.remove('placeholder');
            }
        }

        getSelectedValues() {
            return Array.from(this.options)
                .filter(opt => opt.classList.contains('selected'))
                .map(opt => opt.getAttribute('data-value'));
        }
    }

    // Initialize all multi-select components
    let multiSelects = {};
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.multi-select-container').forEach(container => {
            const filterType = container.getAttribute('data-filter');
            multiSelects[filterType] = new MultiSelect(container);

            // Add listener to re-render table when filters change (for brand, year, month, week)
            if (filterType === 'brand' || filterType === 'year' || filterType === 'month' || filterType === 'week') {
                container.querySelectorAll('.multi-select-option').forEach(option => {
                    option.addEventListener('click', () => {
                        setTimeout(() => {
                            renderEditableTable();
                            updateChangesSummary();
                        }, 50);
                    });
                });
            }
        });
    });

    function exportAll() {
        window.location.href = '{{ url_for("export_experiments") }}';
    }

    function clearAll() {
        if (!confirm('Clear all saved experiments?')) return;
        fetch('{{ url_for("clear_experiments") }}', { method: 'POST' })
            .then(() => {
                updateSidebarScenarios();
            });
    }

    // Load baseline forecast on page load
    function loadBaselineForecast() {
        fetch('{{ url_for("calculate") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                changes: {},
                filters: { brands: [], years: [], months: [] },
                edited_rows: tableRows,
                columns: tableColumns
            })
        })
            .then(response => response.json())
            .then(data => {
                baselineData = data.baseline;
                simulatedData = data.simulated;
                displayBaselineResults(data);
            })
            .catch(error => {
                console.error('Error loading baseline:', error);
            });
    }

    // Display baseline results (no changes)
    function displayBaselineResults(data) {
        const quarters = data.quarters;
        const baseline = data.baseline;
        const historical = data.historical || {};
        const historicalQuarters = data.historical_quarters || [];

        console.log('=== DISPLAY BASELINE RESULTS ===');
        console.log('Historical data received:', historical);
        console.log('Historical quarters received:', historicalQuarters);

        let tableHTML = '<div class="table-container"><table class="table table-striped"><thead><tr>';
        tableHTML += '<th>Brand</th>';
        quarters.forEach(q => {
            tableHTML += `<th>${q}</th>`;
        });
        tableHTML += '</tr></thead><tbody>';

        const allBrands = Object.keys(baseline);

        allBrands.forEach(brand => {
            tableHTML += `<tr><td><strong>${brand}</strong></td>`;

            baseline[brand].forEach((baseValue) => {
                tableHTML += `<td>${baseValue.toFixed(2)}</td>`;
            });

            tableHTML += '</tr>';
        });

        tableHTML += '</tbody></table></div>';
        document.getElementById('resultsTable').innerHTML = tableHTML;
        document.getElementById('resultsSection').style.display = 'block';

        populateBrandFilter(Object.keys(baseline));
        createChart(baseline, baseline, quarters, historical, historicalQuarters);
    }

    // Update sidebar scenarios list
    function updateSidebarScenarios() {
        fetch('{{ url_for("list_experiments") }}')
            .then(response => response.json())
            .then(scenarios => {
                const container = document.getElementById('sidebarScenariosList');
                if (!scenarios || scenarios.length === 0) {
                    container.innerHTML = '<div class="experiments-empty">No experiments saved yet</div>';
                    // Set default experiment name
                    setDefaultExperimentName(1);
                    return;
                }

                let html = '';
                scenarios.forEach((scenario, index) => {
                    html += `
                        <div class="scenario-item">
                            <div class="scenario-name">${scenario.name}</div>
                            <div class="scenario-timestamp">${scenario.timestamp}</div>
                            <div class="scenario-actions">
                                <button class="scenario-load-btn" onclick="loadScenario(${index})">Load</button>
                                <button class="scenario-delete-btn" onclick="deleteScenario(${index})">Delete</button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;

                // Set default experiment name based on count
                setDefaultExperimentName(scenarios.length + 1);
            })
            .catch(error => {
                console.error('Error fetching scenarios:', error);
                setDefaultExperimentName(1);
            });
    }

    // Set default experiment name
    function setDefaultExperimentName(number) {
        const nameInput = document.getElementById('experimentName');
        if (nameInput) {
            nameInput.placeholder = `Experiment_${number}`;
            // Only auto-fill if it's still a default value or empty
            if (!nameInput.value.trim() || nameInput.value.match(/^Experiment_\d+$/)) {
                nameInput.value = `Experiment_${number}`;
            }
        }
    }

    // Load a scenario
    function loadScenario(index) {
        fetch('{{ url_for("list_experiments") }}')
            .then(response => response.json())
            .then(scenarios => {
                if (scenarios && scenarios[index]) {
                    const scenario = scenarios[index];
                    baselineData = scenario.baseline_data;
                    simulatedData = scenario.simulated_data;

                    const data = {
                        baseline: scenario.baseline_data,
                        simulated: scenario.simulated_data,
                        quarters: ['2024 Q3', '2024 Q4', '2025 Q1', '2025 Q2']
                    };

                    displayResults(data);

                    // Update experiment name for next save
                    setDefaultExperimentName(scenarios.length + 1);
                }
            })
            .catch(error => {
                console.error('Error loading scenario:', error);
                alert('Error loading experiment. Please try again.');
            });
    }

    // Delete a scenario
    function deleteScenario(index) {
        if (!confirm('Delete this experiment?')) return;

        fetch(`{{ url_for("delete_experiment", index=0) }}`.replace('/0', `/${index}`), {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateSidebarScenarios();
                }
            })
            .catch(error => {
                console.error('Error deleting scenario:', error);
                alert('Error deleting experiment. Please try again.');
            });
    }

    // Select all options in a filter
    function selectAllFilter(filterType, event) {
        event.preventDefault();
        event.stopPropagation();

        const multiSelect = multiSelects[filterType];
        if (multiSelect) {
            const options = multiSelect.container.querySelectorAll('.multi-select-option');
            options.forEach(option => {
                if (!option.classList.contains('selected')) {
                    option.classList.add('selected');
                }
            });
            multiSelect.updateValue();

            // Update table for regular filters, chart for chart-brand filter
            if (filterType === 'chart-brand') {
                if (baselineData && simulatedData) {
                    createChart(baselineData, simulatedData, ['2024 Q3', '2024 Q4', '2025 Q1', '2025 Q2'], historicalData || {}, historicalQuarters || []);
                }
            } else {
                renderEditableTable();
                updateChangesSummary();
            }
        }
    }

    // Clear all selections in a filter
    function clearFilter(filterType, event) {
        event.preventDefault();
        event.stopPropagation();

        const multiSelect = multiSelects[filterType];
        if (multiSelect) {
            const options = multiSelect.container.querySelectorAll('.multi-select-option');
            options.forEach(option => {
                option.classList.remove('selected');
            });
            multiSelect.updateValue();

            // Update table for regular filters, chart for chart-brand filter
            if (filterType === 'chart-brand') {
                if (baselineData && simulatedData) {
                    createChart(baselineData, simulatedData, ['2024 Q3', '2024 Q4', '2025 Q1', '2025 Q2'], historicalData || {}, historicalQuarters || []);
                }
            } else {
                renderEditableTable();
                updateChangesSummary();
            }
        }
    }

    // Reset all filters and changes to original uploaded data
    function resetAllFilters() {
        if (!confirm('Reset all changes to original uploaded values?')) return;

        // Reload the page data from server
        window.location.reload();
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Initialize original table rows for comparison
        originalTableRows = JSON.parse(JSON.stringify(tableRows));

        renderEditableTable();
        loadBaselineForecast();
        updateSidebarScenarios();

        // Add event listener for percentage toggle
        const percentageToggle = document.getElementById('percentageToggle');
        if (percentageToggle) {
            percentageToggle.addEventListener('change', togglePercentageView);
        }
    });
</script>
{% endblock %}