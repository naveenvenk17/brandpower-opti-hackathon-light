{% extends "base.html" %}

{% block title %}Analysis - BrandCompass.ai{% endblock %}

{% block content %}
<style>
    /* Override container constraints for full-width layout */
    body {
        margin: 0;
        padding: 0;
    }

    .main-content {
        padding: 0 !important;
    }

    .page-layout {
        display: flex;
        min-height: 100vh;
        width: 100%;
        margin: 0;
        padding: 0;
        margin-top: -2rem;
    }

    .left-sidebar {
        width: 280px;
        background: #f9fafb;
        border-right: 1px solid #e5e7eb;
        padding: 1.5rem 1rem;
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        overflow-y: auto;
        z-index: 100;
    }

    .main-content-wide {
        flex: 1;
        margin-left: 280px;
        padding: 2rem;
        width: calc(100% - 280px);
    }

    .sidebar-section-name {
        font-size: 0.85rem;
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .scenario-item {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }

    .scenario-item:hover {
        border-color: #B5942F;
        box-shadow: 0 4px 8px rgba(181, 148, 47, 0.15);
        transform: translateY(-2px);
    }

    .scenario-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: #B5942F;
        border-radius: 8px 0 0 8px;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .scenario-item:hover::before {
        opacity: 1;
    }

    .scenario-name {
        font-weight: 600;
        color: #111827;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .scenario-timestamp {
        font-size: 0.7rem;
        color: #6b7280;
        margin-bottom: 0.75rem;
    }

    .scenario-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
    }

    .scenario-load-btn {
        flex: 1;
        padding: 0.4rem 0.75rem;
        font-size: 0.8rem;
        background: #B5942F;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }

    .scenario-load-btn:hover {
        background: #9d7d28;
        transform: scale(1.05);
    }

    .scenario-delete-btn {
        padding: 0.4rem 0.75rem;
        font-size: 0.8rem;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .scenario-delete-btn:hover {
        background: #dc2626;
    }

    .experiments-empty {
        text-align: center;
        padding: 2rem 1rem;
        color: #9ca3af;
        font-size: 0.875rem;
        font-style: italic;
    }

    @media (max-width: 1024px) {
        .left-sidebar {
            width: 240px;
        }

        .main-content-wide {
            margin-left: 240px;
            width: calc(100% - 240px);
        }
    }
</style>

<div class="page-layout">
    <!-- Left Sidebar -->
    <div class="left-sidebar">
        <div style="text-align: center; padding: 1.5rem 0; border-bottom: 2px solid #e5e7eb; margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.5rem; font-weight: 700; color: #111827; margin: 0;">BrandCompass.ai</h2>
        </div>

        <div class="sidebar-section-name">Your experiments</div>
        <div id="sidebarScenariosList">
            <div class="experiments-empty">No experiments saved yet</div>
        </div>

        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
            <button class="btn btn-secondary btn-block" onclick="exportAll()" style="margin-bottom: 0.5rem;">Export
                All</button>
            <button class="btn btn-secondary btn-block" onclick="clearAll()">Clear All</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content-wide">
        <h1 class="hero-title text-center mb-4">Brand Power Analysis</h1>





        <section class="mb-5">
            <h2 class="section-header">Adjust Marketing Spend</h2>

            <div class="card">
                <div class="card-body">
                    <div style="display:flex; gap:1rem; align-items:center; flex-wrap: wrap; margin-bottom: 0.75rem;">
                        <!-- Brand Filter Multi-Select -->
                        <div class="multi-select-container" data-filter="brand">
                            <button class="multi-select-trigger" type="button" aria-haspopup="listbox"
                                aria-expanded="false">
                                <span class="multi-select-value">Select brands</span>
                                <span class="multi-select-icon">▼</span>
                            </button>
                            <div class="multi-select-dropdown">
                                <div class="multi-select-search">
                                    <input type="text" placeholder="Search brands..." data-search="brand">
                                </div>
                                <div class="multi-select-options" role="listbox">
                                    {% for brand in brands %}
                                    <div class="multi-select-option"
                                        data-value="{{ brand }}" data-filter-type="brand" role="option">
                                        <div class="multi-select-checkbox"></div>
                                        <span>{{ brand }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Year Filter Multi-Select -->
                        <div class="multi-select-container" data-filter="year">
                            <button class="multi-select-trigger" type="button" aria-haspopup="listbox"
                                aria-expanded="false">
                                <span class="multi-select-value">Select years</span>
                                <span class="multi-select-icon">▼</span>
                            </button>
                            <div class="multi-select-dropdown">
                                <div class="multi-select-search">
                                    <input type="text" placeholder="Search years..." data-search="year">
                                </div>
                                <div class="multi-select-options" role="listbox">
                                    {% for year in years %}
                                    <div class="multi-select-option"
                                        data-value="{{ year }}" data-filter-type="year" role="option">
                                        <div class="multi-select-checkbox"></div>
                                        <span>{{ year }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <!-- Month Filter Multi-Select -->
                        <div class="multi-select-container" data-filter="month">
                            <button class="multi-select-trigger" type="button" aria-haspopup="listbox"
                                aria-expanded="false">
                                <span class="multi-select-value">Select months</span>
                                <span class="multi-select-icon">▼</span>
                            </button>
                            <div class="multi-select-dropdown">
                                <div class="multi-select-search">
                                    <input type="text" placeholder="Search months..." data-search="month">
                                </div>
                                <div class="multi-select-options" role="listbox">
                                    {% for month in months %}
                                    <div class="multi-select-option"
                                        data-value="{{ month }}" data-filter-type="month" role="option">
                                        <div class="multi-select-checkbox"></div>
                                        <span>Month {{ month }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <label style="display:flex; align-items:center; gap:0.4rem; margin-right: 1rem;">
                            <input type="checkbox" id="percentageToggle"> <span>Show as Percentage</span>
                        </label>

                        <button class="btn btn-secondary" onclick="resetAllFilters()">Reset All Changes</button>
                    </div>

                    <div id="editableTable" class="table-container" style="max-height: 420px; overflow: auto;"></div>
                </div>
            </div>
        </section>

        <section class="mb-5 text-center">
            <h2 class="section-header">Calculate Brand Power</h2>

            <div class="card" style="max-width: 600px; margin: 0 auto;">
                <div class="card-body">
                    <button class="btn btn-primary btn-large btn-block" onclick="calculatePower()">Calculate Brand
                        Power</button>
                </div>
            </div>
        </section>

        <section id="resultsSection" class="mb-5" style="display: none;">
            <h2 class="section-header">Results</h2>

            <div class="card">
                <div class="card-header">Quarterly Brand Power Forecast</div>
                <div class="card-body">
                    <div id="resultsTable" style="max-height: 450px; overflow-y: auto;"></div>
                    <div style="display: flex; gap: 1rem; align-items: center; margin-top: 1rem;">
                        <label class="form-label" style="margin: 0;">Filter brands:</label>
                        <div class="multi-select-container" data-filter="chart-brand">
                            <button class="multi-select-trigger" type="button" aria-haspopup="listbox"
                                aria-expanded="false">
                                <span class="multi-select-value">Select brands for chart</span>
                                <span class="multi-select-icon">▼</span>
                            </button>
                            <div class="multi-select-dropdown">
                                <div class="multi-select-search">
                                    <input type="text" placeholder="Search brands..." data-search="chart-brand">
                                </div>
                                <div class="multi-select-options" role="listbox" id="chartBrandOptions">
                                    <!-- Options populated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="chartContainer" class="mt-4"></div>
                </div>
            </div>
        </section>

        <section class="mb-5">
            <h2 class="section-header">Save Current Experiment</h2>

            <div class="card">
                <div class="card-body">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label class="form-label">Experiment Name:</label>
                            <input type="text" id="experimentName" class="form-control" placeholder="experiment_1">
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn btn-accent btn-block" onclick="saveExperiment()"
                                style="background: #B5942F; border-color: #B5942F;"
                                onmouseover="this.style.background='#9d7d28'"
                                onmouseout="this.style.background='#B5942F'">Save Experiment</button>
                        </div>
                    </div>
                    <div id="saveStatus" class="mt-3"></div>
                </div>
            </div>
        </section>

        <div class="text-center mb-5">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to Home</a>
        </div>
    </div>
</div>

<style>
    input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        height: 8px;
        background: linear-gradient(to right, var(--danger) 0%, var(--medium-gray) 50%, var(--success) 100%);
        border-radius: 5px;
        outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: var(--primary-blue);
        border: 3px solid var(--white);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: var(--shadow-md);
    }

    input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: var(--primary-blue);
        border: 3px solid var(--white);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: var(--shadow-md);
    }
</style>

<!-- Server-provided data for JS -->
<div id="server-data" data-table-columns='{{ table_columns | tojson | safe if table_columns is defined else "[]" }}'
    data-table-rows='{{ table_rows | tojson | safe if table_rows is defined else "[]" }}'
    data-feature-columns='{{ feature_columns | tojson | safe if feature_columns is defined else "[]" }}'>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    let baselineData = null;
    let simulatedData = null;
    let currentChanges = {};
    const __serverEl = document.getElementById('server-data');
    let tableColumns = JSON.parse((__serverEl && __serverEl.dataset.tableColumns) ? __serverEl.dataset.tableColumns : '[]');
    let tableRows = JSON.parse((__serverEl && __serverEl.dataset.tableRows) ? __serverEl.dataset.tableRows : '[]');
    let featureColumns = JSON.parse((__serverEl && __serverEl.dataset.featureColumns) ? __serverEl.dataset.featureColumns : '[]');

    function renderEditableTable() {
        const container = document.getElementById('editableTable');
        if (!container) return;

        const featuresSet = new Set(featureColumns);

        // Get filter values
        const selBrands = multiSelects['brand'] ? multiSelects['brand'].getSelectedValues() : [];
        const selYears = multiSelects['year'] ? multiSelects['year'].getSelectedValues().map(v => parseInt(v)) : [];
        const selMonths = multiSelects['month'] ? multiSelects['month'].getSelectedValues().map(v => parseInt(v)) : [];

        // Determine ID column names (flexible)
        const brandCol = tableColumns.find(c => c.toLowerCase() === 'brand') || 'brand';
        const yearCol = tableColumns.find(c => c.toLowerCase() === 'year') || 'year';
        const monthCol = tableColumns.find(c => c.toLowerCase() === 'month') || 'month';

        let html = '<table class="table table-striped"><thead><tr>';
        tableColumns.forEach(col => { html += `<th>${col}</th>`; });
        html += '</tr></thead><tbody>';

        tableRows.forEach((row, rIdx) => {
            // Apply filters
            let show = true;
            if (selBrands.length > 0 && brandCol && row[brandCol]) {
                show = show && selBrands.includes(String(row[brandCol]));
            }
            if (selYears.length > 0 && yearCol && row[yearCol]) {
                show = show && selYears.includes(parseInt(row[yearCol]));
            }
            if (selMonths.length > 0 && monthCol && row[monthCol]) {
                show = show && selMonths.includes(parseInt(row[monthCol]));
            }

            if (!show) return; // Skip filtered out rows

            html += '<tr>';
            tableColumns.forEach(col => {
                const val = row[col] !== undefined ? row[col] : '';
                const isEditable = featuresSet.has(col);
                if (isEditable) {
                    html += `<td><input type="number" data-row="${rIdx}" data-col="${col}" value="${val}" class="form-control" style="min-width: 100px;"></td>`;
                } else {
                    html += `<td>${val}</td>`;
                }
            });
            html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;

        container.querySelectorAll('input[data-row]')?.forEach(input => {
            input.addEventListener('change', (e) => {
                const rowIndex = parseInt(e.target.getAttribute('data-row'));
                const colName = e.target.getAttribute('data-col');
                const newVal = parseFloat(e.target.value);
                tableRows[rowIndex][colName] = isNaN(newVal) ? 0 : newVal;
                // accumulate total change per feature (% change vs original sum not known here); we pass absolute deltas
                if (!isNaN(newVal)) {
                    currentChanges[colName] = (currentChanges[colName] || 0) + 0; // placeholder; server uses sums
                }
            });
        });
    }

    function togglePercentageView() {
        const checked = document.getElementById('percentageToggle').checked;
        // In a full implementation we would recompute percentages server-side.
        // For now we keep values as-is; calculation endpoint uses absolute deltas.
    }

    function calculatePower() {
        const resultsSection = document.getElementById('resultsSection');
        resultsSection.style.display = 'none';

        const spinner = document.createElement('div');
        spinner.innerHTML = '<div class="spinner"></div><p class="text-center">Calculating brand power...</p>';
        document.getElementById('resultsTable').innerHTML = '';
        document.getElementById('resultsTable').appendChild(spinner);
        resultsSection.style.display = 'block';

        // gather filters from multi-select components
        const selBrands = multiSelects['brand'] ? multiSelects['brand'].getSelectedValues() : [];
        const selYears = multiSelects['year'] ? multiSelects['year'].getSelectedValues().map(v => parseInt(v)) : [];
        const selMonths = multiSelects['month'] ? multiSelects['month'].getSelectedValues().map(v => parseInt(v)) : [];

        fetch('{{ url_for("calculate") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                changes: currentChanges,
                filters: { brands: selBrands, years: selYears, months: selMonths },
                edited_rows: tableRows,
                columns: tableColumns
            })
        })
            .then(response => response.json())
            .then(data => {
                baselineData = data.baseline;
                simulatedData = data.simulated;
                displayResults(data);
            })
            .catch(error => {
                document.getElementById('resultsTable').innerHTML = `
            <div class="alert alert-danger">
                <strong>✗ Error:</strong> ${error.message}
            </div>
        `;
            });
    }

    function displayResults(data) {
        const quarters = data.quarters;
        const baseline = data.baseline;
        const simulated = data.simulated;

        let tableHTML = '<div class="table-container"><table class="table table-striped"><thead><tr>';
        tableHTML += '<th>Brand</th>';
        quarters.forEach(q => {
            tableHTML += `<th>${q}</th>`;
        });
        tableHTML += '</tr></thead><tbody>';

        // Filter out brands that do not have prediction data
        const allBrands = Object.keys(baseline).filter(brand => {
            return baseline[brand] && baseline[brand].length > 0 && simulated[brand] && simulated[brand].length > 0;
        });

        allBrands.forEach(brand => {
            tableHTML += `<tr><td><strong>${brand}</strong></td>`;

            if (baseline[brand] && baseline[brand].length > 0 && simulated[brand] && simulated[brand].length > 0) {
                baseline[brand].forEach((baseValue, i) => {
                    const simValue = simulated[brand][i];
                    let changeText = '';
                    let changeValue = 0;
                    if (baseValue === 0) {
                        if (simValue > 0) {
                            changeText = 'New';
                            changeValue = Infinity;
                        } else {
                            changeText = 'N/A';
                            changeValue = 0;
                        }
                    } else {
                        changeValue = ((simValue - baseValue) / baseValue) * 100;
                        changeText = `${changeValue > 0 ? '+' : ''}${changeValue.toFixed(1)}%`;
                    }
                    const color = changeValue >= 0 ? '#10b981' : '#ef4444';
                    tableHTML += `<td style="text-align: left;">
                        <span style="font-weight: 600;">${simValue.toFixed(2)}</span>
                        <span style="font-size: 0.75rem; color: ${color}; margin-left: 0.5rem;">
                            ${changeText}
                        </span>
                    </td>`;
                });
            } else {
                quarters.forEach(() => {
                    tableHTML += `<td style="text-align: center;">N/A</td>`;
                });
            }

            tableHTML += '</tr>';
        });

        tableHTML += '</tbody></table></div>';
        document.getElementById('resultsTable').innerHTML = tableHTML;

        populateBrandFilter(Object.keys(baseline));
        createChart(baseline, simulated, quarters);
    }

    function createChart(baseline, simulated, quarters) {
        const traces = [];
        const selected = multiSelects['chart-brand'] ? multiSelects['chart-brand'].getSelectedValues() : [];
        const brandsToShow = selected.length ? selected : Object.keys(baseline);

        brandsToShow.forEach((brand, i) => {
            traces.push({
                x: quarters,
                y: baseline[brand],
                mode: 'lines+markers',
                name: `${brand} - Baseline`,
                line: { width: 3 },
                marker: { size: 8 }
            });

            traces.push({
                x: quarters,
                y: simulated[brand],
                mode: 'lines+markers',
                name: `${brand} - Simulated`,
                line: { width: 3, dash: 'dash' },
                marker: { size: 8, symbol: 'diamond' }
            });
        });

        const layout = {
            title: 'Baseline vs Simulated Power Forecast',
            xaxis: { title: 'Quarter' },
            yaxis: { title: 'Power' },
            height: 500,
            hovermode: 'x unified'
        };

        Plotly.newPlot('chartContainer', traces, layout);
    }

    function saveExperiment() {
        const name = document.getElementById('experimentName').value.trim();

        if (!name) {
            document.getElementById('saveStatus').innerHTML = `
            <div class="alert alert-warning">
                <strong>⚠ Please enter an experiment name.</strong>
            </div>
        `;
            return;
        }

        if (!baselineData || !simulatedData) {
            document.getElementById('saveStatus').innerHTML = `
            <div class="alert alert-warning">
                <strong>⚠ Please calculate results first.</strong>
            </div>
        `;
            return;
        }

        fetch('{{ url_for("save_experiment") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                baseline_data: baselineData,
                simulated_data: simulatedData,
                changes: currentChanges
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('saveStatus').innerHTML = `
            <div class="alert alert-success">
                <strong>✓ Experiment saved successfully!</strong> (Total: ${data.experiment_count})
            </div>
            `;
                    document.getElementById('experimentName').value = '';
                    updateSidebarScenarios();
                }
            })
            .catch(error => {
                document.getElementById('saveStatus').innerHTML = `
            <div class="alert alert-danger">
                <strong>✗ Error:</strong> ${error.message}
            </div>
        `;
            });
    }

    function populateBrandFilter(brands) {
        const optionsContainer = document.getElementById('chartBrandOptions');
        if (!optionsContainer || !brands) return;

        optionsContainer.innerHTML = '';
        brands.forEach((b, index) => {
            const opt = document.createElement('div');
            // Only select the first brand by default
            opt.className = index === 0 ? 'multi-select-option selected' : 'multi-select-option';
            opt.setAttribute('data-value', b);
            opt.setAttribute('data-filter-type', 'chart-brand');
            opt.setAttribute('role', 'option');
            opt.innerHTML = `
                <div class="multi-select-checkbox"></div>
                <span>${b}</span>
            `;
            optionsContainer.appendChild(opt);
        });

        // Reinitialize the chart brand multi-select
        const chartBrandContainer = document.querySelector('[data-filter="chart-brand"]');
        if (chartBrandContainer) {
            multiSelects['chart-brand'] = new MultiSelect(chartBrandContainer);

            // Add change listener
            chartBrandContainer.querySelectorAll('.multi-select-option').forEach(option => {
                option.addEventListener('click', () => {
                    setTimeout(() => {
                        if (baselineData && simulatedData) {
                            createChart(baselineData, simulatedData, ['2024 Q3', '2024 Q4', '2025 Q1', '2025 Q2']);
                        }
                    }, 50);
                });
            });
        }
    }

    // Multi-Select Dropdown Component Logic
    class MultiSelect {
        constructor(container) {
            this.container = container;
            this.trigger = container.querySelector('.multi-select-trigger');
            this.dropdown = container.querySelector('.multi-select-dropdown');
            this.valueElement = container.querySelector('.multi-select-value');
            this.searchInput = container.querySelector('[data-search]');
            this.options = container.querySelectorAll('.multi-select-option');

            this.init();
        }

        init() {
            // Toggle dropdown
            this.trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                this.toggle();
            });

            // Option selection
            this.options.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    option.classList.toggle('selected');
                    this.updateValue();
                });
            });

            // Search functionality
            if (this.searchInput) {
                this.searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    this.options.forEach(option => {
                        const text = option.textContent.toLowerCase();
                        option.style.display = text.includes(query) ? 'flex' : 'none';
                    });
                });
            }

            // Close on outside click
            document.addEventListener('click', (e) => {
                if (!this.container.contains(e.target)) {
                    this.close();
                }
            });

            // Initialize value
            this.updateValue();
        }

        toggle() {
            const isOpen = this.dropdown.classList.contains('open');
            if (isOpen) {
                this.close();
            } else {
                this.open();
            }
        }

        open() {
            this.dropdown.classList.add('open');
            this.trigger.setAttribute('aria-expanded', 'true');
            if (this.searchInput) this.searchInput.focus();
        }

        close() {
            this.dropdown.classList.remove('open');
            this.trigger.setAttribute('aria-expanded', 'false');
            if (this.searchInput) this.searchInput.value = '';
            // Reset search
            this.options.forEach(option => option.style.display = 'flex');
        }

        updateValue() {
            const selected = Array.from(this.options).filter(opt => opt.classList.contains('selected'));
            const count = selected.length;

            if (count === 0) {
                this.valueElement.textContent = this.valueElement.getAttribute('data-placeholder') || 'Select...';
                this.valueElement.classList.add('placeholder');
            } else if (count === 1) {
                this.valueElement.textContent = selected[0].textContent.trim();
                this.valueElement.classList.remove('placeholder');
            } else {
                this.valueElement.textContent = `${count} selected`;
                this.valueElement.classList.remove('placeholder');
            }
        }

        getSelectedValues() {
            return Array.from(this.options)
                .filter(opt => opt.classList.contains('selected'))
                .map(opt => opt.getAttribute('data-value'));
        }
    }

    // Initialize all multi-select components
    let multiSelects = {};
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.multi-select-container').forEach(container => {
            const filterType = container.getAttribute('data-filter');
            multiSelects[filterType] = new MultiSelect(container);

            // Add listener to re-render table when filters change (for brand, year, month)
            if (filterType === 'brand' || filterType === 'year' || filterType === 'month') {
                container.querySelectorAll('.multi-select-option').forEach(option => {
                    option.addEventListener('click', () => {
                        setTimeout(() => {
                            renderEditableTable();
                        }, 50);
                    });
                });
            }
        });
    });

    function exportAll() {
        window.location.href = '{{ url_for("export_experiments") }}';
    }

    function clearAll() {
        if (!confirm('Clear all saved experiments?')) return;
        fetch('{{ url_for("clear_experiments") }}', { method: 'POST' })
            .then(() => {
                updateSidebarScenarios();

                // Show success notification
                const notification = document.createElement('div');
                notification.className = 'alert alert-success';
                notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; transition: opacity 0.3s;';
                notification.innerHTML = '<strong>✓ All experiments cleared</strong>';
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 2000);
            });
    }


    // Update sidebar scenarios list
    function updateSidebarScenarios() {
        fetch('{{ url_for("list_experiments") }}')
            .then(response => response.json())
            .then(scenarios => {
                const container = document.getElementById('sidebarScenariosList');
                if (!scenarios || scenarios.length === 0) {
                    container.innerHTML = '<div class="experiments-empty">No experiments saved yet</div>';
                    return;
                }

                let html = '';
                scenarios.forEach((scenario, index) => {
                    html += `
                        <div class="scenario-item">
                            <div class="scenario-name">${scenario.name}</div>
                            <div class="scenario-timestamp">${scenario.timestamp}</div>
                            <div class="scenario-actions">
                                <button class="scenario-load-btn" onclick="loadScenario(${index})">Load</button>
                                <button class="scenario-delete-btn" onclick="deleteScenario(${index})">Delete</button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            })
            .catch(error => {
                console.error('Error fetching scenarios:', error);
            });
    }

    // Load a scenario
    function loadScenario(index) {
        fetch('{{ url_for("list_experiments") }}')
            .then(response => response.json())
            .then(scenarios => {
                if (scenarios && scenarios[index]) {
                    const scenario = scenarios[index];
                    baselineData = scenario.baseline_data;
                    simulatedData = scenario.simulated_data;

                    const data = {
                        baseline: scenario.baseline_data,
                        simulated: scenario.simulated_data,
                        quarters: ['2024 Q3', '2024 Q4', '2025 Q1', '2025 Q2']
                    };

                    displayResults(data);

                    // Show success notification
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-success';
                    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; transition: opacity 0.3s;';
                    notification.innerHTML = `<strong>✓ Loaded experiment:</strong> ${scenario.name}`;
                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.style.opacity = '0';
                        setTimeout(() => notification.remove(), 300);
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error loading scenario:', error);
                alert('Error loading experiment. Please try again.');
            });
    }

    // Delete a scenario
    function deleteScenario(index) {
        if (!confirm('Delete this experiment?')) return;

        fetch(`{{ url_for("delete_experiment", index=0) }}`.replace('/0', `/${index}`), {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateSidebarScenarios();

                    // Show success notification
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-success';
                    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; transition: opacity 0.3s;';
                    notification.innerHTML = '<strong>✓ Experiment deleted</strong>';
                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.style.opacity = '0';
                        setTimeout(() => notification.remove(), 300);
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error deleting scenario:', error);
                alert('Error deleting experiment. Please try again.');
            });
    }

    // Reset all filters and changes to original uploaded data
    function resetAllFilters() {
        if (!confirm('Reset all changes to original uploaded values?')) return;

        // Reload the page data from server
        window.location.reload();
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderEditableTable();
        updateSidebarScenarios();
    });
</script>
{% endblock %}