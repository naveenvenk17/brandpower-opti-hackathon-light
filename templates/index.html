{% extends "base.html" %}

{% block title %}Home - BrandCompass.ai{% endblock %}

{% block content %}
<div class="container fade-in">
    <div class="hero">
        <h1 class="hero-title">🧭 BrandCompass.ai</h1>
        <p class="hero-subtitle">Navigate Your Brand's Power with Precision</p>
    </div>

    <section class="mb-5">
        <h2 class="section-header">🌍 Select Country</h2>
        <p class="mb-3">Choose your target market for brand power analysis:</p>

        <div class="country-grid">
            <div class="country-card {% if session.get('selected_country') == 'Brazil' %}selected{% endif %}"
                 onclick="selectCountry('Brazil')">
                <div class="country-flag">🇧🇷</div>
                <div class="country-name">Brazil</div>
            </div>

            <div class="country-card {% if session.get('selected_country') == 'Colombia' %}selected{% endif %}"
                 onclick="selectCountry('Colombia')">
                <div class="country-flag">🇨🇴</div>
                <div class="country-name">Colombia</div>
            </div>

            <div class="country-card {% if session.get('selected_country') == 'US' %}selected{% endif %}"
                 onclick="selectCountry('US')">
                <div class="country-flag">🇺🇸</div>
                <div class="country-name">USA</div>
            </div>
        </div>

        {% if session.get('selected_country') %}
        <div class="alert alert-success mt-3">
            <strong>✓ Selected:</strong>
            {% if session.get('selected_country') == 'Brazil' %}🇧🇷{% endif %}
            {% if session.get('selected_country') == 'Colombia' %}🇨🇴{% endif %}
            {% if session.get('selected_country') == 'US' %}🇺🇸{% endif %}
            {{ session.get('selected_country') }}
        </div>
        {% endif %}
    </section>

    <section class="mb-5">
        <h2 class="section-header">📊 Upload Data</h2>

        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">Upload Your Brand Data</div>
                <div class="card-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">📁</div>
                            <div class="upload-text">
                                <strong>Choose a CSV file or drag and drop</strong>
                            </div>
                            <p class="text-muted mb-3">Upload your brand marketing data</p>
                            <input type="file" id="fileInput" name="file" accept=".csv" class="form-control" onchange="handleFileSelect(event)">
                        </div>
                    </form>

                    <div id="uploadStatus" class="mt-3"></div>

                    {% if session.get('uploaded_file') %}
                    <div class="alert alert-success mt-3">
                        <strong>✓ File uploaded:</strong> {{ session.get('uploaded_file') }}
                        <br>
                        <small>Rows: {{ session.get('data_shape', {}).get('rows', 0) }} |
                               Columns: {{ session.get('data_shape', {}).get('cols', 0) }}</small>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card">
                <div class="card-header">Download Template</div>
                <div class="card-body">
                    <p class="mb-3">Not sure about the format? Download our CSV template with sample data:</p>

                    <a href="{{ url_for('download_template') }}" class="btn btn-accent btn-block mb-3">
                        📥 Download CSV Template
                    </a>

                    <div class="alert alert-info">
                        <strong>Template includes:</strong>
                        <ul class="mt-2 mb-0" style="padding-left: 1.5rem;">
                            <li>Brand identifiers</li>
                            <li>Time period columns</li>
                            <li>Marketing channel data</li>
                            <li>Sample values for reference</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="mb-5 text-center">
        <h2 class="section-header">🚀 Start Simulation</h2>

        <div class="card" style="max-width: 600px; margin: 0 auto;">
            <div class="card-body">
                {% if not session.get('selected_country') or not session.get('uploaded_file') %}
                <div class="alert alert-warning">
                    <strong>⚠ Requirements:</strong>
                    <ul class="mt-2 mb-0" style="padding-left: 1.5rem; text-align: left;">
                        {% if not session.get('selected_country') %}
                        <li>Select a country</li>
                        {% endif %}
                        {% if not session.get('uploaded_file') %}
                        <li>Upload your data file</li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}

                <button
                    class="btn btn-primary btn-large btn-block"
                    onclick="startSimulation()"
                    {% if not session.get('selected_country') or not session.get('uploaded_file') %}disabled{% endif %}>
                    🚀 Start Simulation
                </button>

                {% if session.get('selected_country') and session.get('uploaded_file') %}
                <p class="mt-3 text-muted">Ready to analyze your brand power!</p>
                {% endif %}
            </div>
        </div>
    </section>
</div>

<style>
.text-muted {
    color: var(--medium-gray);
}

.upload-area {
    cursor: pointer;
}

.upload-area:hover {
    border-color: var(--accent-yellow);
}

#fileInput {
    margin-top: var(--spacing-md);
}
</style>

<script>
function selectCountry(country) {
    fetch('{{ url_for("select_country") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'country=' + encodeURIComponent(country)
    })
    .then(response => {
        if (response.ok) {
            window.location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    const statusDiv = document.getElementById('uploadStatus');
    statusDiv.innerHTML = '<div class="spinner"></div><p class="text-center">Uploading...</p>';

    fetch('{{ url_for("upload_file") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <strong>✓ Upload successful!</strong><br>
                    File: ${data.filename}<br>
                    Rows: ${data.rows} | Columns: ${data.cols}
                </div>
            `;
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    <strong>✗ Upload failed:</strong> ${data.error}
                </div>
            `;
        }
    })
    .catch(error => {
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <strong>✗ Error:</strong> ${error.message}
            </div>
        `;
    });
}

function startSimulation() {
    window.location.href = '{{ url_for("analysis") }}';
}

// Drag and drop functionality
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.style.borderColor = 'var(--accent-yellow)';
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.style.borderColor = 'var(--primary-blue-light)';
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.style.borderColor = 'var(--primary-blue-light)';

    const files = e.dataTransfer.files;
    if (files.length > 0) {
        fileInput.files = files;
        handleFileSelect({ target: { files: files } });
    }
});
</script>
{% endblock %}
